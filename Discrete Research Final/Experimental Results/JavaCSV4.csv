,,,,,,,,,,,,,,,,,,,
//?????????
if,(logicChkRoomByDeadPeople(roomId))
{
continue,;
}
//???????,?1??????
//????????????,??????????
String[],sitDownResult,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,userSession.getRemoteEndPoint().toString()),;
int,sitDownStatus,=,Integer.parseInt(sitDownResult[0]),;//tempRef_sitDownStatus.argvalue,;
sitDown,=,Boolean.valueOf(sitDownResult[1]),;
if,(sitDown)
{
TimedAutoMatchRoom_Sub_SitDown_Ok(room,,userSession),;
break,;
},//end,if
},//end,if
},//end,for
return,sitDown,;
}
/**,
TimedAutoMatch????,????
@param,room
@param,userSession
*/
private,void,TimedAutoMatchRoom_Sub_SitDown_Ok(IRoomModel,room,,AppSession,userSession)
{
try
{
String,svrAction,=,ServerAction.joinOK,;
//
StringBuilder,contentXml,=,new,StringBuilder(),;
//?????xml??
//IRoomModel,room,=,logicGetRoom(roomId),;
String,roomXml,=,room.toXMLString(),;
//???????code
//contentXml.Append("<code>0</code>"),;
contentXml.append(roomXml),;
//??
Send(userSession,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//log
Log.WriteStrBySend(svrAction,,userSession.getRemoteEndPoint().toString()),;
//??,uER,=,UserEnterRoom
String,svrAction_uER,=,ServerAction.uER,;
IUserModel,sitDownUser,=,logicGetUser(userSession.getRemoteEndPoint().toString()),;
String,chairAndUserXml,=,room.getChair(sitDownUser).toXMLString(),;
netTurnRoom(userSession.getRemoteEndPoint().toString(),,room.getId(),,svrAction_uER,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,String.valueOf(room.getId()),,"",,svrAction_uER),;
}
catch,(UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedAutoMatch_Sub_SitDown",,exd.getMessage()),;
}
}
/**
*,??
*/
public,void,TimedRoomJuShi()
{
try
{
IRoomModel,room,;
for,(Object,roomKey,:,roomList.keySet())
{
room,=,(IRoomModel)roomList.get(roomKey),;
String,roomStatus,=,room.getStatus(),;
if(roomStatus.equals(RoomStatusByChChess.GAME_START))
{
if,(!room.isWaitReconnection())
{
RoomModelByChChess,r,=,(RoomModelByChChess)room,;
String,turnUserId,=,r.getTurn(),;
IUserModel,turnUser,=,this.logicGetUserById(turnUserId),;
String,turnUserIpPort,=,"",;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
if(turnUser,!=,null){
turnUserIpPort,=,turnUser.getStrIpPort(),;
}
String,black,=,r.getBlack(),;
String,red,=,r.getRed(),;
if(turnUserId.equals(red))
{,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//clock
int,curRedJuShiTime,=,r.getCurRedJuShiTime(),+,GameLPU.DELAY,;
r.setCurRedJuShiTime(curRedJuShiTime),;
if(r.getCurRedJuShiTime(),>,r.getMaxJuShiTime())
{
//????,,,,,,,,,,,,,,,,,,,,,,,,,,,,
r.setGameOver(QiziName.red_jiang_1),;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//check,game,over
logicCheckGameOver(room.getId(),,turnUserIpPort),;
}
}else,if(turnUserId.equals(black))
{
//clock
int,curBlackJuShiTime,=,r.getCurBlackJuShiTime(),+,GameLPU.DELAY,;
r.setCurBlackJuShiTime(curBlackJuShiTime),;
//,,,,,,,,,,,,,,,,,,,,,,,,,,>=
if,(r.getCurBlackJuShiTime(),>,r.getMaxJuShiTime())
{
//????,,,,,,,,,,,,,,,,,,,,,,,,,,,,
r.setGameOver(QiziName.black_jiang_1),;
//check,game,over
logicCheckGameOver(room.getId(),,turnUserIpPort),;
}
}
}
}
}//end,for
},
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedRoomJuShi",,exd.getMessage()),;
}
}
/**,
??????,????????
*/
public,void,TimedWaitReconnection()
{
try
{
IRoomModel,room,;
for,(Object,roomKey,:,roomList.keySet())
{
room,=,(IRoomModel)roomList.get(roomKey),;
if,(room.isWaitReconnection())
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??????
//room.CurWaitReconnectionTime,+=,GameGlobals.msgTimeDelay,;
int,curWaitReconnectionTime,=,room.getCurWaitReconnectionTime(),+,GameLPU.DELAY,;
room.setCurWaitReconnectionTime(curWaitReconnectionTime),;
if,(room.getCurWaitReconnectionTime(),>=,room.getMaxWaitReconnectionTime())
{
//
IUserModel,waitUser,=,room.getWaitReconnectionUser().clone(),;
String,waitUserIpPort,=,waitUser.getStrIpPort(),;
room.setWaitReconnection(null),;
//????,,,,,,,,,,,,,,,,,,,,,,,,,,,,
room.setGameOver(waitUser),;
//check,game,over
logicCheckGameOver(room.getId(),,waitUserIpPort),;
//
room.setLeaveUser(waitUser),;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
}
}
catch,(UnsupportedEncodingException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedWaitReconnection",,exd.getMessage()),;
}
}
public,void,trace(String,value)
{
System.out.println(value),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server,;
import,net.silverfoxserver.core.socket.AppSession,;
import,net.silverfoxserver.core.socket.SessionMessage,;
import,net.silverfoxserver.core.log.Log,;
import,System.Xml.XmlDocument,;
import,java.io.UnsupportedEncodingException,;
import,java.util.Timer,;
import,net.silverfoxserver.core.array.QueueMethod,;
import,net.silverfoxserver.core.array.SessionMsgQueue,;
import,net.silverfoxserver.core.array.SmqOppResult,;
import,net.silverfoxserver.core.protocol.ClientAction,;
import,net.silverfoxserver.core.protocol.DBServerAction,;
import,net.silverfoxserver.core.protocol.RCServerAction,;
import,net.silverfoxserver.core.protocol.ServerAction,;
import,net.silverfoxserver.core.server.GameLPU,;
import,net.wdqipai.server.extmodel.*,;
import,org.jboss.netty.channel.ChannelEvent,;
import,org.jboss.netty.channel.MessageEvent,;
/**,
?????LPU,Logic,process
*/
public,class,ChChessLPU,extends,GameLPU
{
/**
*,??
*,
*/
private,static,ChChessLPU,_instance,=,null,;
public,static,ChChessLPU,getInstance()
{
if(null,==,_instance)
{
_instance,=,new,ChChessLPU(),;
}
return,_instance,;
},,,
	
@Override
public,void,init()
{
getMsgTimer().schedule(new,MsgTimedTask(),,0,,GameLPU.DELAY),;
//_msgTimer.Enabled,=,true,;
}
@Override
public,void,msgTimedEvent(),throws,UnsupportedEncodingException
{
SmqOppResult,ruCount,=,getmsgList().Opp(QueueMethod.Count,,null),;
int,len,=,ruCount.count,;
for,(int,i,=,0,;,i,<,len,;,i++)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,?????Session
SmqOppResult,ruShift,=,getmsgList().Opp(QueueMethod.Shift,,null),;
if,(!ruShift.oppSucess)
{
Log.WriteStrByArgument(ChChessLPU.class.getName(),,"msgTimedEvent",,"QueueMethod.Shift",,"oppSucess,is,false"),;
continue,;
}
if(null,==,ruShift.item)
{
Log.WriteStrByArgument(ChChessLPU.class.getName(),,"msgTimedEvent",,"QueueMethod.Shift",,"item,is,null"),;
continue,;
}
SessionMessage,item,=,ruShift.item,;
//
XmlDocument,doc,=,item.doc(),;
String,strIpPort,=,item.strIpPort(),;
String,action,=,item.action(),;
ChannelEvent,e,=,item.e(),;
item.Dereference(),;
AppSession,c,=,new,AppSession(e.getChannel(),e),;
//Socket,session,=,null,;
//AppSession,c,=,null,;
//
//,,,,,,,,,,,,,,,,,,,,if,(!item.getfromServer())
//,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,if,(ChChessLogic.getInstance().netHasSession(strIpPort))
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,c,=,ChChessLogic.getInstance().netGetSession(strIpPort),;
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,},//end,if
//
//,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,else
//,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,if,(item.getfromDBServer())
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,session,=,ChChessLogic.getInstance().DBConnector.getSocket(),;
//
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,else,if,(item.getfromRCServer())
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,session,=,ChChessLogic.getInstance().RCConnector.getSocket(),;
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,},//end,if
//,,,,,,,,,,,,,,,,,,,,}
if,(!item.getfromServer())
{
if,(action.equals(ClientAction.verChk))
{
ChChessLogic.getInstance().doorVerChk(c,,doc),;
continue,;
}
if,(action.equals(ClientAction.loadDBType))
{
ChChessLogic.getInstance().doorLoadDBType(c,,doc),;
continue,;
}
if,(action.equals(ClientAction.reg))
{
ChChessLogic.getInstance().doorReg(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.login))
{
ChChessLogic.getInstance().doorLogin(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.heartBeat))
{
ChChessLogic.getInstance().doorHeartBeat(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.loadG))
{
ChChessLogic.getInstance().doorLoadG(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.loadD))
{
ChChessLogic.getInstance().doorLoadD(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.listRoom))
{
ChChessLogic.getInstance().doorListRoom(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.joinRoom))
{
ChChessLogic.getInstance().doorJoinRoom(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.joinReconnectionRoom))
{
ChChessLogic.getInstance().doorJoinReconnectionRoom(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.autoJoinRoom))
{
ChChessLogic.getInstance().doorAutoJoinRoom(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.autoMatchRoom))
{
ChChessLogic.getInstance().doorAutoMatchRoom(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.pubMsg))
{
ChChessLogic.getInstance().doorPubMsg(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.pubAuMsg))
{
ChChessLogic.getInstance().doorPubAuMsg(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.setRvars))
{
ChChessLogic.getInstance().doorSetRvars(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.setMvars))
{
ChChessLogic.getInstance().doorSetMvars(c,,doc,,item),;
continue,;
}
if,(action.equals(ClientAction.leaveRoom))
{
ChChessLogic.getInstance().doorLeaveRoom(c,,doc,,item),;
continue,;
}
//if,(CLIENT_ACTION.leaveRoomAndGoHallAutoMatch,==,action)
//{
//,,,,ChChessLogic.getInstance().doorLeaveRoomAndGoHallAutoMatch(c,,doc,,item),;
//,,,,continue,;
//}
if,(action.equals(ClientAction.sessionClosed))
{
ChChessLogic.getInstance().logicSessionClosed(strIpPort),;
continue,;
}
}else
{
//
if,(action.equals(ServerAction.needProof))
{
ChChessRCLogic.getInstance().doorNeedProof(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.proofOK))
{
ChChessRCLogic.getInstance().doorProofOK(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.proofKO))
{
ChChessRCLogic.getInstance().doorProofKO(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.loadDBTypeOK))
{
ChChessRCLogic.getInstance().doorLoadDBTypeOK(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.logOK))
{
ChChessRCLogic.getInstance().doorLogOK(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.logKO))
{
ChChessRCLogic.getInstance().doorLogKO(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.regOK))
{
ChChessRCLogic.getInstance().doorRegOK(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.regKO))
{
ChChessRCLogic.getInstance().doorRegKO(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.loadGOK))
{
ChChessRCLogic.getInstance().doorLoadGOK(c,,doc,,item),;
continue,;
}
if,(action.equals(ServerAction.chkEveryDayLoginAndGetOK))
{
ChChessRCLogic.getInstance().doorChkEveryDayLoginAndGetOK(c,,doc,,item),;
continue,;
}
}
}//end,for
ChChessLogic.getInstance().TimedAutoMatchRoom(),;
ChChessLogic.getInstance().TimedRoomJuShi(),;
	ChChessLogic.getInstance().TimedWaitReconnection(),;
	ChChessLogic.getInstance().TimedChkHeartBeat(),;
}
	
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server,;
import,System.Xml.XmlDocument,;
import,System.Xml.XmlNode,;
import,java.io.UnsupportedEncodingException,;
import,java.util.logging.Level,;
import,java.util.logging.Logger,;
import,net.silverfoxserver.core.db.DBTypeModel,;
import,net.silverfoxserver.core.log.Log,;
import,net.silverfoxserver.core.model.IUserModel,;
import,net.silverfoxserver.core.protocol.ClientAction,;
import,net.silverfoxserver.core.protocol.ServerAction,;
import,net.silverfoxserver.core.server.GameLogicServer,;
import,net.silverfoxserver.core.server.RecordLogicClientServer,;
import,net.silverfoxserver.core.socket.AppSession,;
import,net.silverfoxserver.core.socket.SessionMessage,;
import,net.silverfoxserver.core.socket.XmlInstruction,;
import,net.silverfoxserver.core.util.SR,;
import,net.wdqipai.server.extfactory.UserModelFactory,;
import,org.jdom2.Element,;
import,org.jdom2.JDOMException,;
/**
*
*,@author,FUX
*/
public,class,ChChessRCLogic,extends,RecordLogicClientServer,{
/**
*,
*,@return,
*/
@Override
public,String,CLASS_NAME()
{,,,,,,,,,,,,
return,ChChessRCLogic.class.getName(),;,,,,,,,,,,,,,,,,,
}
/**
*,??
*,
*/
private,static,ChChessRCLogic,_instance,=,null,;
public,static,ChChessRCLogic,getInstance()
{
if(null,==,_instance)
{
_instance,=,new,ChChessRCLogic(),;
}
return,_instance,;
}
public,void,init(GameLogicServer,value)
{
super.setGameLogicServer(value),;
}
@Override
public,void,doorLogOK(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
XmlNode,node,=,doc.SelectSingleNode("/msg/body"),;
String,userStrIpPort,=,node.ChildNodes()[0].getText(),;
String,usersex,,,,,=,node.ChildNodes()[1].getText(),;
String,username,=,node.ChildNodes()[2].getText(),;
String,userpwd,=,node.ChildNodes()[3].getText(),;
String,useremail,,,=,node.ChildNodes()[4].getText(),;
String,bbs,=,node.ChildNodes()[5].getText(),;
String,hico,=,node.ChildNodes()[6].getText(),;
String,sid,=,node.ChildNodes()[7].getText(),;
int,id_sql,=,Integer.valueOf(node.ChildNodes()[8].getText()),;
String,id,=,node.ChildNodes()[9].getText(),;
String,status,=,node.ChildNodes()[10].getText(),;
//
String,saction,=,ServerAction.logOK,;
StringBuilder,contentXml,=,new,StringBuilder(),;
//??
//?????session????usersession,????????
AppSession,userSession,=,getGameLogicServer().CLIENTAcceptor.getSession(userStrIpPort),;
//??????,????????,????????????????,?????
AppSession,outSession,=,getGameLogicServer().CLIENTAcceptor.getSessionByAccountName(username),;
if,(null,!=,outSession)
{
//?????,??????????,??:??????????
//????ClearSession
String,logoutAction,=,ServerAction.logout,;
String,logoutCode,=,"1",;
StringBuilder,logoutXml,=,new,StringBuilder(),;
logoutXml.append("<session>").append(userSession.getRemoteEndPoint().toString()).append("</session>"),;
logoutXml.append("<session>").append(outSession.getRemoteEndPoint().toString()).append("</session>"),;
logoutXml.append("<code>").append(logoutCode).append("</code>"),;
logoutXml.append("<u></u>"),;
getGameLogicServer().Send(outSession,,XmlInstruction.fengBao(logoutAction,,logoutXml.toString())),;
//
Log.WriteStrBySend(logoutAction,,outSession.getRemoteEndPoint().toString()),;
//
getGameLogicServer().CLIENTAcceptor.trigClearSession(outSession,,outSession.getRemoteEndPoint().toString()),;
}
//??????????
if,(null,!=,userSession)
{
//if,(userSession.getConnected())
//{
//??????
if,(getGameLogicServer().CLIENTAcceptor.getUserCount(),>=,getGameLogicServer().CLIENTAcceptor.getMaxOnlineUserConfig())
{
//??saction
saction,=,ServerAction.logKO,;
//??status
status,=,"12",;,//??MembershipLoginStatus2.PeopleFull12
contentXml.append("<session>").append(userStrIpPort).append("</session>"),;
contentXml.append("<status>").append(status).append("</status>"),;
contentXml.append("<u></u>"),;
getGameLogicServer().Send(userSession,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,userSession.getRemoteEndPoint().toString()),;
}
else
{
IUserModel,user,=,UserModelFactory.Create(userStrIpPort,,id,,id_sql,,usersex,,username,,username,,bbs,,hico),;
//????????
getGameLogicServer().CLIENTAcceptor.addUser(userSession.getRemoteEndPoint().toString(),,user),;
contentXml.append("<session>").append(userStrIpPort).append("</session>"),;
contentXml.append("<status>").append(status).append("</status>"),;
contentXml.append(user.toXMLString()),;
getGameLogicServer().Send(userSession,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,userSession.getRemoteEndPoint().toString()),;
},//end,if
//},//end,if
},//end,if
}
catch,(JDOMException,|,UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME(),,"doorLogOK",,exd.getMessage()),;
}
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server,;
/**
*
*,@author,FUX
*/
import,java.io.UnsupportedEncodingException,;
import,java.time.LocalTime,;
import,java.util.Timer,;
import,java.util.logging.Level,;
import,java.util.logging.Logger,;
import,net.silverfoxserver.core.log.Log,;
public,class,MsgTimedTask,extends,java.util.TimerTask{
@Override
public,void,run(),{
try,{
//,TODO,Auto-generated,method,stub
ChChessLPU.getInstance().msgTimedEvent(),;
},catch,(UnsupportedEncodingException,ex),{
Log.WriteStrByException(MsgTimedTask.class.getName(),,"run",,ex.getMessage()),;
}
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server,;
/**
*
*,@author,FUX
*/
public,class,RoomViewBg,{
public,static,int,getJuShiTotal(int,tab)
{
//var,activeTab:int,=,GameGlobals.qpc.data.activeTab,;
//if(getBaoGanRoomTab(),==,GameGlobals.qpc.data.activeTab)
if(0,==,tab)
{
return,600,;
}else,if(1,==,tab)
{
return,1200,;
}else,if(2,==,tab)
{
return,1500,;
}else
{
return,1500,;
}		
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extfactory,;
import,net.silverfoxserver.core.model.IChairModel,;
import,net.wdqipai.server.extmodel.*,;
import,net.wdqipai.server.*,;
//
//
public,final,class,ChairModelFactory
{
	/**,
	,????,??,return,???
	,
	,@return,
	*/
	public,static,IChairModel,Create(int,id)
	{
		return,new,ChairModelByChChess(id),;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extfactory,;
import,net.silverfoxserver.core.model.ILookChairModel,;
import,net.wdqipai.server.extmodel.LookChairModelByChChess,;
/**
*
*,@author,FUX
*/
public,class,LookChairModelFactory,{
/**,
	,????,??,return,???
	,
	,@return,
	*/
	public,static,ILookChairModel,Create(int,id)
	{
		return,new,LookChairModelByChChess(id),;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extfactory,;
import,java.io.IOException,;
import,net.silverfoxserver.core.model.IRoomModel,;
import,net.wdqipai.server.extmodel.RoomModelByChChess,;
import,org.jdom2.JDOMException,;
/**
*
*,@author,FUX
*/
public,class,RoomModelFactory,{
public,static,IRoomModel,Create(int,roomId,,int,tab),throws,JDOMException,,IOException
{
return,new,RoomModelByChChess(roomId,,tab,,""),;
}
public,static,IRoomModel,Create(int,roomId,,int,tab,,String,gridXml),throws,JDOMException,,IOException
{
return,new,RoomModelByChChess(roomId,,tab,,gridXml),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extfactory,;
import,net.silverfoxserver.core.model.ITabModel,;
import,net.wdqipai.server.extmodel.TabModelByChChess,;
/**
*
*,@author,FUX
*/
public,class,TabModelFactory,{
public,static,ITabModel,Create(int,tab)
{
return,new,TabModelByChChess(tab),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extfactory,;
import,net.silverfoxserver.core.model.IUserModel,;
import,net.wdqipai.server.extmodel.*,;
import,net.wdqipai.server.*,;
//
//
public,final,class,UserModelFactory
{
/**,
@return,,
*/
public,static,IUserModel,Create(String,strIpPort,,String,id,,int,id_sql,,String,sex,,String,accountName,,String,nickName,,String,bbs,,String,headIco)
{
return,new,UserModelByChChess(strIpPort,,id,,id_sql,,sex,,accountName,,nickName,,bbs,,headIco),;
}
public,static,IUserModel,CreateEmpty()
{
return,new,UserModelByChChess(),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
/**
*
*,@author,FUX
*/
public,class,AutoMatchRoomModel,{
private,String,_strIpPort,;
private,int,_tab,;
public,final,int,getTab()
{
return,_tab,;
}
private,int,_roomOldId,;
public,AutoMatchRoomModel(String,strIpPort,,int,roomTab,,int,roomOldId)
{
this._strIpPort,=,strIpPort,;
this._tab,=,roomTab,;
this._roomOldId,=,roomOldId,;
}
public,final,String,getStrIpPort()
{
return,_strIpPort,;
}
public,final,int,getRoomOldId()
{
return,_roomOldId,;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.silverfoxserver.core.model.IChairModel,;
import,net.silverfoxserver.core.model.IUserModel,;
import,net.silverfoxserver.core.util.AS3Util,;
import,net.wdqipai.server.extmodel.*,;
import,net.wdqipai.server.extfactory.*,;
import,net.wdqipai.server.*,;
//
public,class,ChairModelByChChess,implements,IChairModel
{
	/**
	,,*,????
	,,*,
	,*,id????????????
	,,*/
	private,int,_id,;
	public,final,int,getId()
	{
		return,_id,;
	}
	/**,
	,
	*/
	private,IUserModel,_user,;
	/**,
	,
	*/
	private,boolean,_ready,;
	public,ChairModelByChChess(int,value)
	{
		this._id,=,value,;
		this._user,=,UserModelFactory.CreateEmpty(),;
		this._ready,=,false,;
	}
//	public,final,int,getId()
//	{
//		return,this._id,;
//	}
	public,final,IUserModel,getUser()
	{
		return,this._user,;
	}
//	public,final,IUserModel,getUser()
//	{
//
//		return,this._user,;
//
//	}
	/**,
	,???????setProperty??,???????
	,????
	,
	,@param,user
	*/
	public,final,void,setUser(IUserModel,value)
	{
		this._user,=,value.clone(),;
		//this._user.setProperty(user.getStrIpPort(),,user.Id,,user.getId_SQL(),,user.getG(),user.getSex(),,user.getAccountName(),,user.getNickName(),,user.getBbs(),user.getHeadIco()),;
	}
	public,final,boolean,isReady()
	{
		return,this._ready,;
	}
	public,final,void,setReady(boolean,value)
	{
		this._ready,=,value,;
		if,(value)
		{
			if,(this._user.getId().equals(""))
			{
				throw,new,IllegalArgumentException("setReady,must,this,chair,has,people"),;
			}
		}
	}
	public,final,String,getReadyAdd()
	{
		//nothing
		return,"",;
	}
	public,final,void,setReadyAdd(String,value)
	{
		//nothing
	}
	public,final,void,reset()
	{
		//
		setUser(new,UserModelByChChess()),;
		//
		this._ready,=,false,;
	}
	/**,
	,
	,
	,@return,
	*/
	public,final,String,toXMLString()
	{
		StringBuilder,sb,=,new,StringBuilder(),;
		//
		sb.append("<chair,id='"),;
		sb.append(String.valueOf(this.getId())),;
		sb.append("',ready='"),;
		sb.append(AS3Util.convertBoolToAS3(this.isReady())),;
		sb.append("'>"),;
		sb.append(this.getUser().toXMLString()),;
		sb.append("</chair>"),;
		return,sb.toString(),;
	}
	/**,
	,AS3,0-?,1-?
	,
	,@param,value
	,@return,
	*/
	public,final,String,convertBoolToAS3(boolean,value)
	{
		if,(value)
		{
			return,"1",;
		}
		return,"0",;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,System.Xml.XmlDocument,;
import,java.io.IOException,;
import,net.wdqipai.server.*,;
import,org.jdom2.JDOMException,;
/**,
??
?????factory
*/
public,class,ChessBoardByChChess
{
	
	/**,
	,??
	*/
	public,String[][],grid,;
	/**,
	,??????
	*/
	public,String,gridXml,;
	/**,
	,????????????????,?????,new,???????????????:
	
	VBC#C++F#JScript
	??int[,],array5,;
	array5,=,new,int[,],{,{,1,,2,},,{,3,,4,},,{,5,,6,},,{,7,,8,},},;,,,//,OK
	array5,=,{{1,2},,{3,4},,{5,6},,{7,8}},;,,,//,Error
	*/
	public,ChessBoardByChChess(),throws,JDOMException,,IOException
	{
		this.gridXml,=,"",;
		//
		reset(),;
	}
	public,ChessBoardByChChess(String,gridXml),throws,JDOMException,,IOException
	{
		this.gridXml,=,gridXml,;
		//
		reset(),;
	}
	/**,
	,????
	*/
	public,final,void,reset(),throws,JDOMException,,IOException
	{
		if,(gridXml.equals(""))
		{
			grid,=,new,String[][]{
{QiziName.black_ju_2,QiziName.black_ma_2,QiziName.black_xiang_2,QiziName.black_shi_2,QiziName.black_jiang_1,QiziName.black_shi_1,QiziName.black_xiang_1,QiziName.black_ma_1,QiziName.black_ju_1},,
{"","","","","","","","",""},,
{"",QiziName.black_pao_1,"","","","","",QiziName.black_pao_2,""},,
{QiziName.black_bing_5,"",QiziName.black_bing_4,"",QiziName.black_bing_3,"",QiziName.black_bing_2,"",QiziName.black_bing_1},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{QiziName.red_bing_1,"",QiziName.red_bing_2,"",QiziName.red_bing_3,"",QiziName.red_bing_4,"",QiziName.red_bing_5},,
{"",QiziName.red_pao_1,"","","","","",QiziName.red_pao_2,""},,
{"","","","","","","","",""},,
{QiziName.red_ju_1,QiziName.red_ma_1,QiziName.red_xiang_1,QiziName.red_shi_1,QiziName.red_jiang_1,QiziName.red_shi_2,QiziName.red_xiang_2,QiziName.red_ma_2,QiziName.red_ju_2}
},;
		}
		else
		{
			grid,=,new,String[][]{
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""},,
{"","","","","","","","",""}
},;
			XmlDocument,gridDoc,=,new,XmlDocument(),;
			gridDoc.LoadXml(gridXml),;
			int,len,=,0,;//gridDoc.DocumentElement.ChildNodes.size(),;
			//???????????????,?????try,catch
			try
			{
				for,(int,i,=,0,;,i,<,len,;,i++)
				{
//					XmlNode,gridNode,=,gridDoc.DocumentElement.ChildNodes[i],;
//
//					String,qn,=,gridNode.Attributes["n"].Value,;
//					int,x,=,(int)(gridNode.Attributes["x"].Value),;
//					int,y,=,(int)(gridNode.Attributes["y"].Value),;
//
//					grid[x][y],=,qn,;
				}
			}
			catch,(RuntimeException,exd)
			{
				//System.out.println("???????:",+,gridDoc.DocumentElement.Attributes["name"].Value,+,",",+,exd.getMessage()),;
			}
		}
	}
	/**,
	,??????????????,
	,??????,??????
	,
	,@param,viewName
	,@param,h
	,@param,v
	*/
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,public,void,update(string,viewName,,uint,h,uint,v)
	public,final,void,update(String,viewName,,int,h,,int,v)
	{
		//clear
		for,(int,i,=,0,;,i,<,10,;,i++)
		{
			for,(int,j,=,0,;,j,<,9,;,j++)
			{
				if,(viewName.equals(grid[i][j]))
				{
					grid[i][j],=,"",;
					break,;
				}
			}
		}
		//move
		//??????
		grid[(h,-,1)][(v,-,1)],=,viewName,;
	}
	/**,
	,???????????,???????
	,
	,@param,name
	,@return,
	*/
	public,final,Qizi,getQizi(String,viewName)
	{
		for,(int,i,=,0,;,i,<,10,;,i++)
		{
			for,(int,j,=,0,;,j,<,9,;,j++)
			{
				if,(viewName.equals(grid[i][j]))
				{
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,uint,h,=,Convert.ToUInt32(i+1),;
					int,h,=,(int)(i,+,1),;
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,uint,v,=,Convert.ToUInt32(j,+,1),;
					int,v,=,(int)(j,+,1),;
					return,new,Qizi(viewName,,h,,v),;
				}
			}
		}
		throw,new,IllegalArgumentException("can't,find,",+,viewName,+,",on,chess,board"),;
	}
	public,final,String,toXMLString()
	{
		StringBuilder,sb,=,new,StringBuilder(),;
		//chessboard???item??
		for,(int,i,=,0,;,i,<,10,;,i++)
		{
			for,(int,j,=,0,;,j,<,9,;,j++)
			{
				if,("",!=,grid[i][j])
				{
					//qizi???item
					sb.append("<item,n='"),;
					sb.append(grid[i][j]),;
					sb.append("',h='"),;
					int,k,=,i,+,1,;
					sb.append((new,Integer(k)).toString()),;
					sb.append("',v='"),;
					int,m,=,j,+,1,;
					sb.append((new,Integer(m)).toString()),;
					sb.append("'/>"),;
				}
			}
		},//end,for
		return,sb.toString(),;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.silverfoxserver.core.model.ILookChairModel,;
import,net.silverfoxserver.core.model.IUserModel,;
import,net.wdqipai.server.extfactory.UserModelFactory,;
/**
*
*,@author,FUX
*/
public,class,LookChairModelByChChess,implements,ILookChairModel{
/**
	,,*,????
	,,*,
	,*,id????????????
	,,*/
	private,int,_id,;
	public,final,int,getId()
	{
		return,_id,;
	}
	/**,
	,
	*/
	private,IUserModel,_user,;
public,LookChairModelByChChess(int,value)
	{
		this._id,=,value,;
		this._user,=,UserModelFactory.CreateEmpty(),;
	}
public,final,IUserModel,getUser()
	{
		return,this._user,;
	}
public,final,void,setUser(IUserModel,value)
	{
		this._user,=,value.clone(),;
		
	}
public,final,String,toXMLString()
	{
		StringBuilder,sb,=,new,StringBuilder(),;
		//
		sb.append("<lookChair,id='"),;
		sb.append(String.valueOf(this.getId())),;
		//sb.append("',ready='"),;
		//sb.append(convertBoolToAS3(this.getisReady())),;
		sb.append("'>"),;
		sb.append(this.getUser().toXMLString()),;
		sb.append("</lookChair>"),;
		return,sb.toString(),;
	}
public,void,reset()
{
//
this._user,=,UserModelFactory.CreateEmpty(),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.wdqipai.server.*,;
public,class,MatchResultByChChess
{
public,final,static,String,RED_WIN,=,"red_win",;
public,final,static,String,BLACK_WIN,=,"black_win",;
/**,
??
*/
public,final,static,String,HE,=,"he",;
/**,
??????
*/
public,final,static,String,EMPTY,=,"",;
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.wdqipai.server.*,;
/**,
??????????????
*/
public,class,Qizi
{
	/**,
	,
	*/
	public,String,fullName,;
	/**,
	,
	*/
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,public,uint,h,;
	public,int,h,;
	/**,
	,
	*/
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,public,uint,v,;
	public,int,v,;
	/**,
	,
	,
	,@param,fullName
	,@param,h
	,@param,v
	*/
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,public,Qizi(string,fullName,,uint,h,,uint,v)
	public,Qizi(String,fullName,,int,h,,int,v)
	{
		this.fullName,=,fullName,;
		this.h,=,h,;
		this.v,=,v,;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,System.Console,;
import,net.wdqipai.server.*,;
/**,
???????????,fullName,????Qizi?view.name
?????fullName
?????chName
*/
public,class,QiziMoveRecord
{
	/**
	,*,p,==,point
	,*/,
	private,String,p1_chName,=,"",;
	private,String,p1_fullName,=,"",;
	private,int,p1_h,=,0,;
	private,int,p1_v,=,0,;
	private,String,p2_chName,=,"",;
	private,String,p2_fullName,=,"",;
	private,int,p2_h,=,0,;
	private,int,p2_v,=,0,;
private,Boolean,_isFull,=,false,;
public,final,Qizi,getP1()
	{
		return,new,Qizi(p1_fullName,,p1_h,,p1_v),;
	}
//,,,,,,,,public,final,Qizi,getP2()
//	{
//		return,new,Qizi(p2_fullName,,p2_h,,p2_v),;
//	}
	public,final,void,setP1(String,fullName,,int,h,,int,v)
	{
if(_isFull)
{
Console.WriteLine("QiziMoveRecord,is,full!"),;
return,;
}
//
//this.p1_chName,=,chName,;
this.p1_fullName,=,fullName,;
this.p1_h,=,h,;
this.p1_v,=,v,;
//
//,,,,,,,,,,,,this.p2_chName,=,"",;
//,,,,,,,,,,,,this.p2_h,=,0,;
//,,,,,,,,,,,,this.p2_v,=,0,;
	}
	public,final,void,setP2(String,fullName,,int,h,,int,v)
	{
//this.p2_chName,=,chName,;
this.p2_fullName,=,fullName,;
this.p2_h,=,h,;
this.p2_v,=,v,;
_isFull,=,true,;
	}
public,Boolean,isFull()
{
return,_isFull,;
}
	public,final,void,reset()
	{
p1_chName,=,"",;
p1_fullName,=,"",;
p1_h,=,0,;
p1_v,=,0,;
p2_chName,=,"",;
p2_fullName,=,"",;
p2_h,=,0,;
p2_v,=,0,;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.wdqipai.server.*,;
/**,
?????State.Room.RoomModel.QiziName??
*/
public,class,QiziName
{
//En????,??
public,final,static,String,En_Bing,=,"bing",;
public,final,static,String,En_Pao,=,"pao",;
public,final,static,String,En_Ju,=,"ju",;
public,final,static,String,En_Ma,=,"ma",;
public,final,static,String,En_Xiang,=,"xiang",;
public,final,static,String,En_Shi,=,"shi",;
public,final,static,String,En_Jiang,=,"jiang",;
/**
*,????
*/
public,final,static,String,red_bing_1,=,"red_bing_1",;
public,final,static,String,red_bing_2,=,"red_bing_2",;
public,final,static,String,red_bing_3,=,"red_bing_3",;
public,final,static,String,red_bing_4,=,"red_bing_4",;
public,final,static,String,red_bing_5,=,"red_bing_5",;
public,final,static,String,red_pao_1,=,"red_pao_1",;
public,final,static,String,red_pao_2,=,"red_pao_2",;
public,final,static,String,red_ju_1,=,"red_ju_1",;
public,final,static,String,red_ju_2,=,"red_ju_2",;
public,final,static,String,red_ma_1,=,"red_ma_1",;
public,final,static,String,red_ma_2,=,"red_ma_2",;
public,final,static,String,red_xiang_1,=,"red_xiang_1",;
public,final,static,String,red_xiang_2,=,"red_xiang_2",;
public,final,static,String,red_shi_1,=,"red_shi_1",;
public,final,static,String,red_shi_2,=,"red_shi_2",;
public,final,static,String,red_jiang_1,=,"red_jiang_1",;
/**
*,????
*/
public,final,static,String,black_bing_1,=,"black_bing_1",;
public,final,static,String,black_bing_2,=,"black_bing_2",;
public,final,static,String,black_bing_3,=,"black_bing_3",;
public,final,static,String,black_bing_4,=,"black_bing_4",;
public,final,static,String,black_bing_5,=,"black_bing_5",;
public,final,static,String,black_pao_1,=,"black_pao_1",;
public,final,static,String,black_pao_2,=,"black_pao_2",;
public,final,static,String,black_ju_1,=,"black_ju_1",;
public,final,static,String,black_ju_2,=,"black_ju_2",;
public,final,static,String,black_ma_1,=,"black_ma_1",;
public,final,static,String,black_ma_2,=,"black_ma_2",;
public,final,static,String,black_xiang_1,=,"black_xiang_1",;
public,final,static,String,black_xiang_2,=,"black_xiang_2",;
public,final,static,String,black_shi_1,=,"black_shi_1",;
public,final,static,String,black_shi_2,=,"black_shi_2",;
public,final,static,String,black_jiang_1,=,"black_jiang_1",;
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.silverfoxserver.core.model.ILookChairModel,;
import,net.silverfoxserver.core.model.IRoomModel,;
import,net.silverfoxserver.core.model.IChairModel,;
import,net.silverfoxserver.core.model.IUserModel,;
import,System.Xml.XmlDocument,;
import,chchessserver.Program,;
import,java.io.IOException,;
import,java.util.logging.Level,;
import,java.util.logging.Logger,;
import,net.silverfoxserver.core.log.Log,;
import,net.wdqipai.server.extmodel.*,;
import,net.wdqipai.server.extfactory.*,;
import,net.wdqipai.server.*,;
import,org.jdom2.JDOMException,;
//
//
/**,
*/
public,class,RoomModelByChChess,implements,IRoomModel
{
/**,
	??id
*/
private,final,int,_id,;
@Override
public,final,int,getId()
{
return,this._id,;
}
/**,
????,??
??????tab,navigate,??
*/
private,final,int,_tab,;
@Override
public,final,int,getTab()
{
return,this._tab,;
}
/**,
???????????
*/
private,int,_tabAutoMatchMode,;
/**,
???
*/
private,int,_tabQuickRoomMode,;
@Override
public,final,void,setTabQuickRoomMode(int,value)
{
this._tabQuickRoomMode,=,value,;
}
/**,
??
*/
private,int,_diG,;
/**,
????
*/
private,int,_carryG,;
/**,
????,???
*/
private,float,_costG,;
/**,
?????????
*/
private,String,_costU,;
private,String,_costUid,;
/**,
????
*/
private,String,_name,;
@Override
public,final,String,getName()
{
return,this._name,;
}
@Override
public,final,void,setName(String,value)
{
_name,=,value,;
}
/**,
????
*/
private,String,_pwd,;
@Override
public,final,String,getPwd()
{
return,this._pwd,;
}
@Override
public,final,void,setPwd(String,value)
{
_pwd,=,value,;
}
/**
*,???VIP??
*,
*/
private,int,_vip,;
@Override
public,int,getVip(),{
return,_vip,;
}
@Override
public,void,setVip(int,value),{
_vip,=,value,;
}
/**,
????
*/
private,String,_roomStatus,;
public,final,String,getStatus()
{
return,this._roomStatus,;
}
private,void,setStatus(String,value)
{
this._roomStatus,=,value,;
}
/**,
????????
*/
private,int,_reconnectionTime,;
public,final,void,setReconnectionTime(int,value)
{
_reconnectionTime,=,value,;
}
/**,
????,????
*/
private,volatile,boolean,_isWaitReconnection,;
public,final,int,getMaxWaitReconnectionTime()
{
return,this._reconnectionTime,*,1000,;
}
private,volatile,int,_curWaitReconnectionTime,;
private,volatile,IUserModel,_waitReconnectionUser,;
public,final,boolean,isWaitReconnection()
{
return,this._isWaitReconnection,;
}
public,final,int,getCurWaitReconnectionTime()
{
return,this._curWaitReconnectionTime,;
}
public,final,void,setCurWaitReconnectionTime(int,value)
{
this._curWaitReconnectionTime,=,value,;
}
public,final,IUserModel,getWaitReconnectionUser()
{
return,this._waitReconnectionUser,;
}
/**,
*/
private,int,_everyDayLogin,;
public,final,void,setEveryDayLogin(int,value)
{
_everyDayLogin,=,value,;
}
public,final,int,getEveryDayLogin()
{
return,_everyDayLogin,;
}
/**,
????
*/
private,String,_matchResult,;
/**,
//,The,.NET,Framework,2.0,way,to,create,a,list
List<int>,list1,=,new,List<int>(),;
//,No,boxing,,no,casting:
//list1.Add(3),;
//,Compile-time,error:
//,list1.Add("It,is,raining,in,Redmond."),;
?????????,???,ArrayList,List<T>,?????????????????????????????????????,???????????,ArrayList,??,???????,??????????????
*/
private,java.util.ArrayList<IChairModel>,_chair,;
public,final,java.util.ArrayList<IChairModel>,getChair()
{
return,this._chair,;
}
public,final,int,getChairCount()
{
return,this._chair.size(),;
}
private,java.util.ArrayList<ILookChairModel>,_lookChair,;
/**,
????
*/
private,ChessBoardByChChess,_chessBorad,;
/**,
???userId
*/
private,String,red,;
public,String,getRed()
{
return,red,;
}
/**,
???userId
*/
private,String,black,;
public,String,getBlack()
{
return,black,;
}
/**,
click????,?????????,?????
*/
private,QiziMoveRecord,_qiziMoveRecord,;
public,QiziMoveRecord,getMoveRecord()
{
return,_qiziMoveRecord,;
}
/**,
????
*/
private,java.util.ArrayList<QiziMoveRecord>,_round,;
/**,
??????
*/
private,boolean,_allowPlayerGlessThanZeroOnGameOver,;
public,final,void,setAllowPlayerGlessThanZeroOnGameOver(boolean,value)
{
_allowPlayerGlessThanZeroOnGameOver,=,value,;
}
/**,
??????,??????
*/
//private,int,_runAwayMultiG,;
/**,
??????
@param,value
*/
public,final,void,setRunAwayMultiG(int,value)
{
//_runAwayMultiG,=,value,;
}
/**,
*/
private,int,_clock,;
public,final,void,setClockPlusPlus()
{
_clock++,;
}
public,final,int,getClock()
{
return,_clock,;
}
/**
*,
*,
*/
private,int,_blackJuShi,;
public,final,int,getCurBlackJuShiTime()
{
return,_blackJuShi,;
}
public,void,setCurBlackJuShiTime(int,value)
{
_blackJuShi,=,value,;
}
/**
*,
*,
*/
public,final,int,getMaxJuShiTime()
{
return,RoomViewBg.getJuShiTotal(getTab()),*,1000,;
}
/**
*,
*,
*/
private,int,_redJuShi,;
public,final,int,getCurRedJuShiTime()
{
return,_redJuShi,;
}
public,void,setCurRedJuShiTime(int,value)
{
_redJuShi,=,value,;
}
/**
*,
*/
private,int,_qiuHe,;
public,void,setQiuHePlusPlus()
{
_qiuHe++,;
}
public,final,int,getQiuHe()
{
return,_qiuHe,;
}
/**
*,
*,@param,id
*,@param,tab
*,@param,gridXml
*,@throws,JDOMException
*,@throws,IOException,
*/
public,RoomModelByChChess(int,id,,int,tab,,String,gridXml),throws,JDOMException,,IOException
{
this._id,=,id,;
this._tab,=,tab,;
this._blackJuShi,=,0,;
this._redJuShi,=,0,;
if,(gridXml.equals(""))
{
this._name,=,"",;
}
else
{
XmlDocument,gridDoc,=,new,XmlDocument(),;
gridDoc.LoadXml(gridXml),;
this._name,=,gridDoc.getDocumentElement().getAttributeValue("n"),;
}
_pwd,=,"",;
this._roomStatus,=,RoomStatusByChChess.GAME_WAIT_START,;
this._matchResult,=,MatchResultByChChess.EMPTY,;
this._chair,=,new,java.util.ArrayList<IChairModel>(),;
this._lookChair,=,new,java.util.ArrayList<ILookChairModel>(),;
int,i,=0,;,,,,,,,,,,,,
for,(i,=,1,;i,<=,2,;i++)
{
this._chair.add(ChairModelFactory.Create(i)),;
},//end,for
for,(i,=,1,;i,<=,30,;i++)
{
this._lookChair.add(LookChairModelFactory.Create(i)),;
},//end,for
red,=,"",;
black,=,"",;
this._chessBorad,=,new,ChessBoardByChChess(gridXml),;
this._qiziMoveRecord,=,new,QiziMoveRecord(),;
this._round,=,new,java.util.ArrayList<QiziMoveRecord>(),;
}
//Properties
//	public,final,int,getId()
//	{
//		return,this._id,;
//	}
//	public,final,int,getTab()
//	{
//		return,this._tab,;
//	}
public,final,int,getDig()
{
return,this._diG,;
}
/**,
????????,????????????
@param,value
@return,
*/
public,final,void,setDig(int,value)
{
this._diG,=,value,;
}
public,final,int,getCarryg()
{
return,this._carryG,;
}
public,final,void,setCarryg(int,value)
{
this._carryG,=,value,;
}
public,final,float,getCostg()
{
return,this._costG,;
}
public,final,String,getCostU()
{
return,this._costU,;
}
public,final,String,getCostUid()
{
return,this._costUid,;
}
public,final,void,setCostg(float,value,,String,value2,,String,value3)
{
this._costG,=,value,;
this._costU,=,value2,;
this._costUid,=,value3,;
}
public,final,boolean,isTabAutoMatchMode()
{
if,(0,==,this._tabAutoMatchMode)
{
return,false,;
}
return,true,;
}
public,final,int,getTabAutoMatchMode()
{
return,this._tabAutoMatchMode,;
}
public,final,void,setTabAutoMatchMode(int,tabAutoMatchMode)
{
this._tabAutoMatchMode,=,tabAutoMatchMode,;
}
/**,
value,???false
@param,value
*/
public,final,void,setReadyForAllChair(boolean,value)
{
int,len,=,this._chair.size(),;
//?????????
//?????ready
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
chair.setReady(value),;
}
}
public,final,void,reset()
{
this._roomStatus,=,RoomStatusByChChess.GAME_WAIT_START,;
this._matchResult,=,MatchResultByChChess.EMPTY,;
//?????????
//?????ready
setReadyForAllChair(false),;
this._blackJuShi,=,0,;
this._redJuShi,=,0,;
try,{
//?????,??????,???
//??,reset
this._chessBorad.reset(),;
},catch,(JDOMException,|,IOException,ex),
{
Log.WriteStrByException(RoomModelByChChess.class.getName(),,"reset",,,ex.getMessage()),;
}
//????,reset
this._qiziMoveRecord.reset(),;
//????,reset
this._round.clear(),;
}
/**,
string,red,black
????,??,??
@return,
*/
public,final,java.util.ArrayList<IChairModel>,findUser()
{
java.util.ArrayList<IChairModel>,users,=,new,java.util.ArrayList<IChairModel>(),;
//loop,use
int,i,=,0,;
int,len,=,this._chair.size(),;
//add
for,(i,=,0,;,i,<,len,;,i++)
{
if,(this.red.equals(((IChairModel)((this._chair.get(i),instanceof,IChairModel),?,this._chair.get(i),:,null)).getUser().getId()))
{
users.add(((IChairModel)((this._chair.get(i),instanceof,IChairModel),?,this._chair.get(i),:,null))),;
}
}
//add
for,(i,=,0,;,i,<,len,;,i++)
{
if,(!this.red.equals(((IChairModel)((this._chair.get(i),instanceof,IChairModel),?,this._chair.get(i),:,null)).getUser().getId()))
{
users.add(((IChairModel)((this._chair.get(i),instanceof,IChairModel),?,this._chair.get(i),:,null))),;
}
}
return,users,;
}
/**,
????,???"",??????+id??
?????????????
@return,
*/
//	public,final,String,getName()
//	{
//		return,this._name,;
//	}
public,final,int,getLookChairCount()
{
return,this._lookChair.size(),;
}
public,final,java.util.ArrayList<IUserModel>,getAllPeople()
{
java.util.ArrayList<IUserModel>,peopleList,=,new,java.util.ArrayList<IUserModel>(),;
int,j,=,0,;
int,jLen,=,this._chair.size(),;
for,(j,=,0,;,j,<,jLen,;,j++)
{
IChairModel,c,=,this._chair.get(j),;
if,(!c.getUser().getId().equals(""))
{
peopleList.add(c.getUser()),;
}
}
//
jLen,=,this._lookChair.size(),;
for,(j,=,0,;,j,<,jLen,;,j++)
{
ILookChairModel,c,=,this._lookChair.get(j),;
if,(!c.getUser().getId().equals(""))
{
peopleList.add(c.getUser()),;
}
}
return,peopleList,;
}
/**,
for,socket,??
@return,
*/
public,final,java.util.ArrayList<String>,getAllPeopleByStrIpPort()
{
java.util.ArrayList<String>,peopleStrIpPort,=,new,java.util.ArrayList<String>(),;
int,i,=,0,;
int,jLen,=,this._chair.size(),;
for,(i,=,0,;,i,<,jLen,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
peopleStrIpPort.add(chair.getUser().getStrIpPort()),;
}
}
//
jLen,=,this._lookChair.size(),;
for,(i,=,0,;,i,<,jLen,;,i++)
{
ILookChairModel,chair,=,this._lookChair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
peopleStrIpPort.add(chair.getUser().getStrIpPort()),;
}
}
return,peopleStrIpPort,;
}
/**,
???????
@return,
*/
public,final,int,getSomeBodyChairCount()
{
//loop,use
int,len,=,this._chair.size(),;
int,count,=,0,;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
count++,;
}
}
return,count,;
}
public,final,int,getSomeBodyLookChairCount()
{
//loop,use
int,len,=,this._lookChair.size(),;
int,count,=,0,;
for,(int,i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,chair,=,this._lookChair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
count++,;
}
}
return,count,;
}
/**,
?????????
@param,user
@return,
*/
public,final,boolean,hasPeople(IUserModel,user)
{
int,i,;
int,len,;
len,=,this._chair.size(),;
for,(i,=,0,;,i,<,len,;,i++)
{
IChairModel,c,=,this._chair.get(i),;
if,(c.getUser().getId().equals(user.getId()))
{
return,true,;
}
},//end,for
//
len,=,this._lookChair.size(),;
for,(i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,lc,=,this._lookChair.get(i),;
if,(lc.getUser().getId().equals(user.getId()))
{
return,true,;
}
},//end,for
return,false,;
}
public,final,boolean,hasSameIpPeople(IUserModel,user,,boolean,isOnChair)
{
if,(isOnChair)
{
for,(int,i,=,0,;,i,<,this._chair.size(),;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
String[],compare_1,=,chair.getUser().getStrIpPort().split("[:]",,-1),;
String[],compare_2,=,user.getStrIpPort().split("[:]",,-1),;
if,(compare_1[0].equals(compare_2[0]))
{
return,true,;
}
}
},//end,for
}
return,false,;
}
/**,
????????,,hasPeople
@param,user
@return,
*/
public,final,IChairModel,getChair(IUserModel,value)
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,c,=,this._chair.get(i),;
if,(c.getUser().getId().equals(value.getId()))
{
return,c,;
}
},//end,for
//throw,new,ArgumentException("can,not,find,user,",+,user.Id,+,",func:getChair"),;
return,null,;
}
public,final,IChairModel,getChair(String,userId)
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,c,=,this._chair.get(i),;
if,(userId.equals(c.getUser().getId()))
{
return,c,;
}
},//end,for
//throw,new,ArgumentException("can,not,find,user,",+,user,+,",func:getChair"),;
return,null,;
}
public,final,IChairModel,getChair(int,id)
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,c,=,this._chair.get(i),;
if,(c.getId(),==,id)
{
return,c,;
}
},//end,for
//,throw,new,ArgumentException("can,not,find,chair,",+,id.ToString(),+,",func:getChair"),;
return,null,;
}
/**
*,
*,@param,value
*,@return,
*/
public,final,ILookChairModel,getLookChair(IUserModel,value)
{
//loop,use
int,len,=,this._lookChair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,c,=,this._lookChair.get(i),;
if,(c.getUser().getId().equals(value.getId()))
{
return,c,;
}
},//end,for
//throw,new,ArgumentException("can,not,find,user,",+,user.Id,+,",func:getChair"),;
return,null,;
}
public,final,ILookChairModel,getLookChair(String,userId)
{
//loop,use
int,len,=,this._lookChair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,c,=,this._lookChair.get(i),;
if,(userId.equals(c.getUser().getId()))
{
return,c,;
}
},//end,for
//throw,new,ArgumentException("can,not,find,user,",+,user,+,",func:getChair"),;
return,null,;
}
public,final,ILookChairModel,getLookChair(int,id)
{
//loop,use
int,len,=,this._lookChair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,c,=,this._lookChair.get(i),;
if,(c.getId(),==,id)
{
return,c,;
}
},//end,for
//,throw,new,ArgumentException("can,not,find,chair,",+,id.ToString(),+,",func:getChair"),;
return,null,;
}
/**,
??
@param,user
@return,
*/
public,final,boolean,setSitDown(IUserModel,user,Boolean,look)
{
//loop,use
int,i,;
int,len,;
if(look)
{
len,=,this._lookChair.size(),;
for,(i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,chair,=,this._lookChair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
//??,???
}
else
{
chair.setUser(user),;
return,true,;
},//end,if
},//end,for
}else{
len,=,this._chair.size(),;
for,(i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(!chair.getUser().getId().equals(""))
{
//??,???
}
else
{
chair.setUser(user),;
//????
if,(!red.equals("")),//?????
{
if(red.equals(user.getId()))
{
//nothing
//matchoInfo???????,??????????
}else{
black,=,user.getId(),;
}
}
else
{
red,=,user.getId(),;
}
this.setReady(user.getId()),;//????
return,true,;
},//end,if
},//end,for
}
return,false,;
}
/**,
??
@param,userId
*/
@Override
public,final,void,setReady(String,userId)
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(userId.equals(chair.getUser().getId()))
{
if,(chair.isReady())
{
}
else
{
chair.setReady(true),;
//????ok,??????
//?????????????????
if,(hasAllReady())
{
this._roomStatus,=,RoomStatusByChChess.GAME_ALL_READY_WAIT_START,;
//??????ready?????
setReadyForAllChair(false),;
}
break,;
}
}
},//end,for
}
/**,
???????
?????????????
??????,???????,??????ready?????
??????,hasAllReadyCanStart
@return,
*/
private,boolean,hasAllReady()
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(chair.isReady())
{
}
else
{
return,false,;,//??????????,return,false
}
},//end,for
return,true,;
}
public,final,boolean,hasAllReadyCanStart()
{
if,(this._roomStatus.equals(RoomStatusByChChess.GAME_ALL_READY_WAIT_START))
{
return,true,;
}
return,false,;
}
public,final,int,chkVars(String,n,,String,v,,IUserModel,u)
{
int,chkSta,=,RvarsStatus.Success0,;
IChairModel,c,=,this.getChair(u),;
if(null,==,c)
{
chkSta,=,RvarsStatus.YouMustFirstSitDown1,;
return,chkSta,;
}
//
switch,(n),
{
case,"chairReady":
break,;
case,"selectQizi":
break,;
//??
case,"moveToRoad":
break,;
case,"moveToQizi":
break,;
case,"renShu":
break,;
//??
case,"qiuHe":
break,;
//????
case,"qiuHeAgree":
break,;
//?????
case,"qiuHeDeny":
break,;
}
return,chkSta,;
}
/**,
@param,n
@param,v
*/
@Override
public,final,void,setVars(String,n,,String,v)
{
//<val,n="selectQizi",t="s"><![CDATA[red_ju_1]]></val>
//<val,n="moveToQizi",t="s"><![CDATA[black_ma_2]]></val>
switch,(n),{
case,"chairReady":
//userId
this.setReady(v),;
break,;
case,"selectQizi":
Qizi,qizi,=,this._chessBorad.getQizi(v),;
if(_qiziMoveRecord.isFull())
{
_round.add(_qiziMoveRecord),;
_qiziMoveRecord,=,new,QiziMoveRecord(),;
}
//??????
this._qiziMoveRecord.setP1(qizi.fullName,,qizi.h,,qizi.v),;
break,;
//??
case,"moveToRoad":
//??????
Qizi,qiziMoveToRoad,=,this._qiziMoveRecord.getP1(),;
if,(qiziMoveToRoad.fullName.equals(""))
{
throw,new,IllegalArgumentException("moveToRoad:,qiziMoveRecord,getP1,return,null"),;
}
//
String,moveViewName,=,qiziMoveToRoad.fullName,;
//?a???10
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,uint,moveH,=,Convert.ToUInt32(Convert.ToInt32(v.Substring(1,1),16)),;
int,moveH,=,Integer.parseUnsignedInt(v.substring(1,,2),16),;
//C#,TO,JAVA,CONVERTER,WARNING:,Unsigned,integer,types,have,no,direct,equivalent,in,Java:
//ORIGINAL,LINE:,uint,moveV,=,Convert.ToUInt32(Convert.ToInt32(v.Substring(2,1),16)),;
int,moveV,=,Integer.parseUnsignedInt(v.substring(2,,3),16),;
this._qiziMoveRecord.setP2(moveViewName,,moveH,,moveV),;
if(_qiziMoveRecord.isFull())
{
_round.add(_qiziMoveRecord),;
_qiziMoveRecord,=,new,QiziMoveRecord(),;
}
//??????
this._chessBorad.update(moveViewName,,moveH,,moveV),;
//this._chessBorad.
break,;
case,"moveToQizi":
//??????
Qizi,qiziMoveToQizi,=,this._qiziMoveRecord.getP1(),;
if,(qiziMoveToQizi.fullName.equals(""))
{
throw,new,IllegalArgumentException("moveToQizi:,qiziMoveRecord,getP1,return,null"),;
}
Qizi,qiziTarget,=,this._chessBorad.getQizi(v),;
//??????
this._chessBorad.update(qiziMoveToQizi.fullName,,qiziTarget.h,,qiziTarget.v),;
//??????
this._qiziMoveRecord.setP2(qiziMoveToQizi.fullName,,qiziTarget.h,,qiziTarget.v),;
if(_qiziMoveRecord.isFull())
{
_round.add(_qiziMoveRecord),;
_qiziMoveRecord,=,new,QiziMoveRecord(),;
}
//
setGameOver(v),;
break,;
case,"renShu":
setGameOverByRenShu(v),;
break,;
//??
case,"qiuHe":
break,;
//????
case,"qiuHeAgree":
setGameOverByQiuHe(v),;
break,;
//?????
case,"qiuHeDeny":
break,;
}
}
public,final,void,setGameStart()
{
if,(this._roomStatus.equals(RoomStatusByChChess.GAME_ALL_READY_WAIT_START))
{
this._roomStatus,=,RoomStatusByChChess.GAME_START,;
}
}
public,final,void,setGameStart(String,value)
{
//nothing
//C#,TO,JAVA,CONVERTER,NOTE:,The,following,'switch',operated,on,a,string,member,and,was,converted,to,Java,'if-else',logic:
//		switch,(value)
//ORIGINAL,LINE:,case,"":
if,(value.equals(""),||,RoomStatusByChChess.GAME_START.equals(value))
{
if,(this.getStatus().equals(RoomStatusByChChess.GAME_ALL_READY_WAIT_START))
{
this.setStatus(value),;
}
}
else
{
}
}
/**,
???????
0,-,??
1,-,??
@param,userId
@param,category
*/
public,final,void,setGameOverByRenShu(String,userId)
{
//loop,use
int,len,=,this._chair.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(userId.equals(chair.getUser().getId()))
{
if,(this.black.equals(userId))
{
this._matchResult,=,MatchResultByChChess.RED_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
if,(this.red.equals(userId))
{
this._matchResult,=,MatchResultByChChess.BLACK_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
}
},//end,for
}
public,final,void,setGameOverByQiuHe(String,userId)
{
this._matchResult,=,MatchResultByChChess.HE,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
/**,
????????
@param,viewName
*/
public,final,void,setGameOver(String,viewName)
{
//???????
if,(QiziName.black_jiang_1.equals(viewName))
{
this._matchResult,=,MatchResultByChChess.RED_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
if,(QiziName.red_jiang_1.equals(viewName))
{
this._matchResult,=,MatchResultByChChess.BLACK_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
}
/**,
??????????
???????
?????,UserLeave??
?????leaveUser,????????
?????????,?setLeaveUser
@param,leaveUser
*/
public,final,void,setWaitReconnection(IUserModel,waitUser)
{
if,(null,==,waitUser)
{
this._isWaitReconnection,=,false,;
}
else
{
this._isWaitReconnection,=,true,;
}
this._waitReconnectionUser,=,waitUser,;
}
/**,
??????????
???????
?????,UserLeave??
?????leaveUser,????????
@param,leaveUser
*/
public,final,void,setGameOver(IUserModel,leaveUser)
{
//loop,use
//int,len,=,this._chair.size(),;
//,,,,,,,,,,,,for,(int,i,=,0,;,i,<,len,;,i++)
//,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,IChairModel,chair,=,this._chair.get(i),;
//
//,,,,,,,,,,,,,,,,,,,,if,(chair.getUser().getId().equals(leaveUser.getId()))
//,,,,,,,,,,,,,,,,,,,,{
if,(this.black.equals(leaveUser.getId()))
{
this._matchResult,=,MatchResultByChChess.RED_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
else
//if,(this.red.equals(leaveUser.getId()))
{
this._matchResult,=,MatchResultByChChess.BLACK_WIN,;
this._roomStatus,=,RoomStatusByChChess.GAMEOVER_WAIT_START,;
}
//}
//},//end,for
//leave
setLeaveUser(leaveUser),;
}
public,final,void,setLeaveUser(IUserModel,leaveUser)
{
//loop,use
int,i,;
int,len,=,this._chair.size(),;
for,(i,=,0,;,i,<,len,;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
if,(chair.getUser().getId().equals(leaveUser.getId()))
{
if,(this.black.equals(leaveUser.getId()))
{
//????
if,(!this.isWaitReconnection())
{
this.black,=,"",;
}
}
if,(this.red.equals(leaveUser.getId()))
{
//
if,(!this.isWaitReconnection())
{
this.red,=,"",;
}
}
//reset
chair.reset(),;
}
},//end,for
//????
for,(i,=,0,;,i,<,len,;,i++)
{
ILookChairModel,lc,=,this._lookChair.get(i),;
if,(lc.getUser().getId().equals(leaveUser.getId()))
{
lc.reset(),;
}
},,,,,,,,
}
public,final,boolean,hasGameOver()
{
if,(this._roomStatus.equals(RoomStatusByChChess.GAMEOVER_WAIT_START))
{
return,true,;
}
return,false,;
}
public,final,boolean,hasGamePlaying()
{
if,(this._roomStatus.equals(RoomStatusByChChess.GAME_START))
{
return,true,;
}
return,false,;
}
public,final,boolean,hasGamePlaying(String,roomStatus)
{
if,(hasGamePlaying())
{
if,(this.getStatus().equals(roomStatus))
{
return,true,;
}
}
return,false,;
}
/**,
??????,????????????
?,-,?,or,?,or,??,or,????
red,,black,,he,,,,,,""
@return,
*/
public,final,String,getWhoWin()
{
if,(this._matchResult.equals(MatchResultByChChess.RED_WIN))
{
return,"red",;
}
if,(this._matchResult.equals(MatchResultByChChess.BLACK_WIN))
{
return,"black",;
}
if,(this._matchResult.equals(MatchResultByChChess.HE))
{
return,"he",;
}
if,(this._matchResult.equals(MatchResultByChChess.EMPTY))
{
return,"",;
}
throw,new,IllegalArgumentException("can,not,found,",+,this._matchResult,+,",in,MATCH_RESULT"),;
}
/**,
?????
@return,
*/
public,final,String,getTurn()
{
if,(this._roomStatus.equals(RoomStatusByChChess.GAME_WAIT_START),||,
this._roomStatus.equals(RoomStatusByChChess.GAMEOVER_WAIT_START))
{
return,"",;
}
int,s,=,this._round.size(),;
if,(0,==,s)
{
return,this.red,;
}
if,(s,>,0)
{
if(s,%,2,==,0)
{
return,this.red,;
}else{
return,this.black,;
}
}
return,this.black,;
}
public,final,String,getMatchInfoXml()
{
StringBuilder,sb,=,new,StringBuilder(),;
//matchInfo,node
sb.append("<match,red='"),;
sb.append(this.red),;
sb.append("',black='"),;
sb.append(this.black),;
sb.append("',round='"),;
sb.append(this._round.size()),;
sb.append("',turn='"),;,//????
sb.append(this.getTurn()),;
sb.append("',win='"),;
sb.append(this.getWhoWin()),;
sb.append("'/>"),;
return,sb.toString(),;
}
/**,
????,?getContentXml??,?????room??
????????,?????
@return,
*/
public,final,String,getMatchXml()
{
StringBuilder,sb,=,new,StringBuilder(),;
sb.append("<room,id='"),;
sb.append((new,Integer(this._id)).toString()),;
sb.append("',name='"),;
sb.append(this._name),;
sb.append("'>"),;
//
sb.append("<match,red='"),;
sb.append(this.red),;,,,,,,,,,,,,
sb.append("',curRedJuShiTime='"),;,,,,,,,,,,,,
sb.append(String.valueOf(this.getCurRedJuShiTime())),;
sb.append("',black='"),;
sb.append(this.black),;,,,,,,,,,,,,
sb.append("',curBlackJuShiTime='"),;,,,,,,,,,,,,
sb.append(String.valueOf(this.getCurBlackJuShiTime())),;
sb.append("',round='"),;
sb.append(this._round.size()),;
sb.append("',turn='"),;,//????
sb.append(this.getTurn()),;
sb.append("',win='"),;
sb.append(this.getWhoWin()),;
sb.append("'/>"),;
//
sb.append("</room>"),;
return,sb.toString(),;
}
/**,
@return,
*/
public,final,String,toXMLString()
{
StringBuilder,sb,=,new,StringBuilder(),;
sb.append("<room,id='"),;
sb.append(String.valueOf(this._id)),;
sb.append("',name='"),;
sb.append(this._name),;
sb.append("',tab='"),;
sb.append(String.valueOf(this._tab)),;
sb.append("'>"),;
//matchInfo,node
sb.append("<match,red='"),;
sb.append(this.red),;,,,,,,,,,,,,
sb.append("',curRedJuShiTime='"),;,,,,,,,,,,,,
sb.append(String.valueOf(this.getCurRedJuShiTime())),;
sb.append("',black='"),;
sb.append(this.black),;,,,,,,,,,,,,
sb.append("',curBlackJuShiTime='"),;,,,,,,,,,,,,
sb.append(String.valueOf(this.getCurBlackJuShiTime())),;
sb.append("',round='"),;
sb.append(this._round.size()),;
sb.append("',turn='"),;,//????
sb.append(this.getTurn()),;
sb.append("',win='"),;
sb.append(this.getWhoWin()),;
sb.append("'/>"),;
//?????,???????
if,(!this.getWhoWin().equals(""))
{
sb.append(getMatchResultXmlByRcContent()),;
}
//chair,node
int,i,=,0,;
for,(i,=,0,;,i,<,this._chair.size(),;,i++)
{
IChairModel,chair,=,this._chair.get(i),;
sb.append(chair.toXMLString()),;
}
//lookChair,node
for,(i,=,0,;,i,<,this._lookChair.size(),;,i++)
{
ILookChairModel,lc,=,this._lookChair.get(i),;
sb.append(lc.toXMLString()),;
}
//item,node
sb.append(this._chessBorad.toXMLString()),;
sb.append("</room>"),;
return,sb.toString(),;
}
/**,
????????,?????????
@return,
*/
public,final,String,getMatchResultXmlByRc()
{
StringBuilder,sb,=,new,StringBuilder(),;
//
sb.append("<room,id='"),;
sb.append(String.valueOf(this._id)),;
sb.append("',name='"),;
sb.append(this._name),;
sb.append("',gamename='"),;
sb.append(Program.GAME_NAME),;
sb.append("'>"),;
//
sb.append(getMatchResultXmlByRcContent()),;
//
sb.append("</room>"),;
return,sb.toString(),;
}
private,String,getMatchResultXmlByRcContent()
{
StringBuilder,sb,=,new,StringBuilder(),;
//????,?,1,,?-1
//??,??
//????,??
int,winG,;
int,lostG,;
String,winId,;
String,lostId,;
String,winNickName,;
String,lostNickName,;
java.util.ArrayList<IChairModel>,users,=,this.findUser(),;
if,(this.getWhoWin().equals("red"))
{
//1v1
winG,=,this.getDig(),;
lostG,=,this.getDig(),;
winId,=,this.red,;
lostId,=,this.black,;
winNickName,=,users.get(0).getUser().getNickName(),;
lostNickName,=,users.get(1).getUser().getNickName(),;
}
else,if,(this.getWhoWin().equals("black"))
{
//1v1
winG,=,this.getDig(),;
lostG,=,this.getDig(),;
winId,=,this.black,;
lostId,=,this.red,;
winNickName,=,users.get(1).getUser().getNickName(),;
lostNickName,=,users.get(0).getUser().getNickName(),;
}
else,if,(this.getWhoWin().equals("he"))
{
//??
winG,=,0,;
lostG,=,0,;
winId,=,this.red,;
lostId,=,this.black,;
winNickName,=,users.get(0).getUser().getNickName(),;
lostNickName,=,users.get(1).getUser().getNickName(),;
}
else
{
throw,new,IllegalArgumentException("may,be,has,one,in,getWhoWin"),;
}
sb.append("<action,type='add',id='"),;
sb.append(winId),;
sb.append("',n='"),;
sb.append(winNickName),;
sb.append("',g='"),;
sb.append((new,Integer(winG)).toString()),;
sb.append("'/>"),;
sb.append("<action,type='sub',id='"),;
sb.append(lostId),;
sb.append("',n='"),;
sb.append(lostNickName),;
sb.append("',g='"),;
sb.append((new,Integer(lostG)).toString()),;
sb.append("'/>"),;
return,sb.toString(),;
}
public,final,String,getFilterContentXml(String,strIpPort,,String,contentXml)
{
//nothing
return,contentXml,;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.wdqipai.server.*,;
/**,
????
*/
public,class,RoomStatusByChChess
{
//????
public,static,final,String,GAME_WAIT_START,=,"game_wait_start",;
//????
//
public,static,final,String,GAME_ALL_READY_WAIT_START,=,"game_all_ready_wait_start",;
//??
public,static,final,String,GAME_START,=,"game_start",;
//?????????
public,static,final,String,GAMEOVER_WAIT_START,=,"gameover_wait_start",;
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
/**
*
*,@author,FUX
*/
public,class,RvarsStatus,{
public,static,final,int,Success0,=,0,;
/**
*,?????,?????Rvars????
*,
*/
public,static,final,int,YouMustFirstSitDown1,=,1,;
//
//,??:
//,,,,,??????
public,static,final,int,ProviderError3,=,3,;
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.silverfoxserver.core.model.ITabModel,;
/**
*
*,@author,FUX
*/
public,class,TabModelByChChess,implements,ITabModel{
/**,
????,??
??????tab,navigate,??
*/
private,int,_tab,;
public,final,int,getId()
{
return,_tab,;
}
public,final,int,getTab()
{
return,_tab,;
}
/**
*,
*,
*/
private,String,_tabName,;
public,final,String,getTabName()
{
return,_tabName,;
}
public,final,void,setTabName(String,value)
{
this._tabName,=,value,;
}
/**,
*/
private,int,_roomCount,;
public,final,int,getRoomCount()
{
return,this._roomCount,;
}
public,final,void,setRoomCount(int,value)
{
_roomCount,=,value,;
}
/**,
*/
private,String[],_roomName,;
public,final,String[],getRoomName()
{
if,(null,==,_roomName)
{
_roomName,=,new,String[_roomCount],;
}
if,(_roomName.length,!=,_roomCount)
{
_roomName,=,new,String[_roomCount],;
}
return,_roomName,;
}
/**,
*/
private,int,_roomG,;
public,final,int,getRoomG()
{
return,this._roomG,;
}
public,final,void,setRoomG(int,value)
{
_roomG,=,value,;
}
/**,
*/
private,float,_roomCostG,;
public,final,float,getRoomCostG()
{
return,this._roomCostG,;
}
public,final,void,setRoomCostG(float,value)
{
_roomCostG,=,value,;
}
/**,
???????????
*/
private,int,_tabAutoMatchMode,;
public,final,void,setTabAutoMatchMode(int,tabAutoMatchMode)
{
this._tabAutoMatchMode,=,tabAutoMatchMode,;
}
public,final,boolean,getIsTabAutoMatchMode()
{
if,(0,==,this._tabAutoMatchMode)
{
return,false,;
}
return,true,;
}
public,final,int,getTabAutoMatchMode()
{
return,this._tabAutoMatchMode,;
}
public,TabModelByChChess(int,tab)
{
this._tab,=,tab,;
}
@Override
public,final,String,toXMLString()
{
String,s,=,"<tab,id='",+,String.valueOf(this._tab),+,
"',n='",+,this._tabName,+,
//"',roomG='",+,String.valueOf(this._roomG),+,//?roomList??????
//"',roomCarryG='",+,String.valueOf(this._roomCarryG),+,
"',tabAutoMatchMode='",+,String.valueOf(this._tabAutoMatchMode),+,
"',></tab>",;
return,s,;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.extmodel,;
import,net.silverfoxserver.core.model.EUserSex,;
import,net.silverfoxserver.core.model.IUserModel,;
import,java.time.LocalTime,;
import,net.wdqipai.server.extmodel.*,;
import,net.wdqipai.server.extfactory.*,;
import,net.wdqipai.server.*,;
//
public,class,UserModelByChChess,implements,IUserModel
{
	/**,
	,?????,????sessionList?userList
	*/
	private,String,_strIpPort,=,"",;
	/**,
	,???xml????
	*/
	private,String,_id,=,"",;
	public,final,String,getId()
	{
		return,this._id,;
	}
	/**,
	,????mssql??
	,
	,getId?,return,,_id_sql??
	*/
	private,int,_id_sql,=,0,;
public,final,int,getId_SQL()
	{
		return,this._id_sql,;
	}
	public,final,void,setId_SQL(int,value)
	{
		this._id_sql,=,value,;
	}
/**
*,
*/
private,int,_vip,=,0,;
public,final,int,getVIP()
	{
		return,this._vip,;
	}
	public,final,void,setVIP(int,value)
	{
		this._vip,=,value,;
	}
	/**,
	,???
	*/
	private,String,_accountName,=,"",;
	/**,
	,??
	*/
	private,String,_nickName,=,"",;
	/**,
	
	*/
	private,String,_bbs,=,"",;
	/**,
	,
	*/
	private,String,_headIco,=,"",;
	/**,
	,
	*/
	private,String,_sex,=,EUserSex.NoBody,;
	/**,
	,
	*/
	private,volatile,int,_g,=,0,;
	/**,
	,??
	*/
	private,volatile,int,_heartTime,=,-1,;
	/**
*,@param,strIpPort
*,@param,id
*,@param,id_sql
*,@param,sex
*,@param,accountName
*,@param,nickName
*,@param,bbs
*,@param,headIco
	*/
	public,UserModelByChChess(String,strIpPort,,String,id,,int,id_sql,,String,sex,,String,accountName,,String,nickName,,String,bbs,,String,hico)
	{
		this._strIpPort,=,strIpPort,;
		this._id,=,id,;
		this._id_sql,=,id_sql,;
		this._sex,=,sex,;
		this._accountName,=,accountName,;
		this._nickName,=,nickName,;
		this._g,=,0,;
		this._bbs,=,bbs,;
		if,(hico.equals("null"))
		{
			hico,=,"",;
		}
		this._headIco,=,hico,;
		//
		this._heartTime,=,LocalTime.now().getMinute(),;//new,java.util.Date().Minute,;
	}
	/**,
	,????user,???????
	,????????????
	*/
	public,UserModelByChChess()
	{
		this._strIpPort,=,"",;
		this._id,=,"",;
		this._id_sql,=,0,;
		this._sex,=,EUserSex.NoBody,;
		this._accountName,=,"",;
		this._nickName,=,"",;
		this._bbs,=,"",;
		this._headIco,=,"",;
		this._heartTime,=,-1,;
	}
	public,final,String,getStrIpPort()
	{
		return,this._strIpPort,;
	}
	public,final,String,getstrIpPort()
	{
		return,this._strIpPort,;
	}
//	public,final,String,getId()
//	{
//		return,this._id,;
//	}
	public,final,void,setId(String,id_)
	{
		this._id,=,id_,;
	}
	
	public,final,int,getG()
	{
		return,this._g,;
	}
	public,final,void,setG(int,g)
	{
		this._g,=,g,;
	}
	public,final,int,getHeartTime()
	{
		return,this._heartTime,;
	}
	public,final,void,setHeartTime(int,value)
	{
		this._heartTime,=,value,;
	}
	public,final,String,getAccountName()
	{
		return,this._accountName,;
	}
	public,final,String,getNickName()
	{
		return,this._nickName,;
	}
//	public,final,String,getNickName()
//	{
//		return,this._nickName,;
//	}
	public,final,String,getSex()
	{
		return,this._sex,;
	}
	public,final,String,getBbs()
	{
		return,this._bbs,;
	}
	public,final,String,getHeadIco()
	{
		//
		if,(this._bbs.toLowerCase().equals("discuz"))
		{
			if,((new,Long(this._id_sql)).toString().equals("0"))
			{
					//
				return,"please,use,client,QiPaiIco,class,,getHeadPhotoPath,function",;
			}
			//return,"/uc_server/avatar.php?uid=",+,this._id_sql.ToString(),+,"&size=middle",;	
			//xml
			return,"/uc_server/avatar.php?uid=",+,(new,Long(this._id_sql)).toString(),+,"&amp,;size=middle",;
		}
		//
		if,(this._bbs.toLowerCase().equals("dvbbs"))
		{
			return,this._headIco,;
		}
		//
		if,(this._bbs.toLowerCase().equals("phpwind"))
		{
			return,this._headIco,;
		}
		return,this._headIco,;
	}
@Override
	public,final,String,toXMLString()
	{
		String,s,=,"<u,id='",+,_id,+,"',id_sql='",+,(new,Long(this._id_sql)).toString(),+,"',n='",+,_nickName,+,"',s='",+,this._sex.toString(),+,"',g='",+,(new,Integer(this._g)).toString(),+,"',bbs='",+,_bbs,+,"',hico='",+,_headIco,+,"',></u>",;
		return,s,;
	}
	public,final,IUserModel,clone()
	{
		UserModelByChChess,u,=,new,UserModelByChChess(_strIpPort,,_id,,_id_sql,,_sex,,_accountName,,_nickName,,_bbs,,_headIco),;
		u.setG(_g),;
		return,u,;
	}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.handler,;
import,System.Xml.XmlDocument,;
import,System.Xml.XmlHelper,;
import,java.io.IOException,;
import,java.net.InetAddress,;
import,java.net.InetSocketAddress,;
import,java.net.SocketAddress,;
import,java.util.logging.Level,;
import,java.util.logging.Logger,;
import,net.silverfoxserver.core.array.QueueMethod,;
import,net.silverfoxserver.core.log.Log,;
import,net.silverfoxserver.core.protocol.ClientAction,;
import,net.silverfoxserver.core.service.IoHandler,;
import,net.silverfoxserver.core.socket.SessionMessage,;
import,net.silverfoxserver.core.util.SHA1ByAdobe,;
import,net.wdqipai.server.ChChessLPU,;
import,org.jboss.netty.channel.Channel,;
import,org.jboss.netty.channel.ChannelEvent,;
import,org.jboss.netty.channel.ChannelFuture,;
import,org.jboss.netty.channel.ChannelFutureListener,;
import,org.jboss.netty.channel.ChannelHandlerContext,;
import,org.jboss.netty.channel.ChannelStateEvent,;
import,org.jboss.netty.channel.ExceptionEvent,;
import,org.jboss.netty.channel.MessageEvent,;
import,org.jboss.netty.channel.SimpleChannelUpstreamHandler,;
import,org.jboss.netty.channel.group.ChannelGroup,;
import,org.jboss.netty.channel.group.DefaultChannelGroup,;
import,org.jboss.netty.handler.ssl.SslHandler,;
import,org.jdom2.Attribute,;
import,org.jdom2.JDOMException,;
/**
*
*,@author,FUX
*/
public,class,ChChessGameClientHandler,implements,IoHandler{
static,final,ChannelGroup,channels,=,new,DefaultChannelGroup(),;
public,void,handleUpstream(ChannelHandlerContext,ctx,,ChannelEvent,e){
if,(e,instanceof,ChannelStateEvent),{
System.err.println(e),;
}
//super.handleUpstream(ctx,,e),;
}
public,void,sessionCreated(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
//,Get,the,SslHandler,in,the,current,pipeline.
//,We,added,it,in,SecureChatPipelineFactory.
//final,SslHandler,sslHandler,=,ctx.getPipeline().get(SslHandler.class),;
//,Get,notified,when,SSL,handshake,is,done.
//,ChannelFuture,handshakeFuture,=,sslHandler.handshake(),;
//handshakeFuture.addListener(new,Greeter(sslHandler)),;
}
public,void,channelDisconnected(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
//,Unregister,the,channel,from,the,global,channel,list
//,so,the,channel,does,not,receive,messages,anymore.
channels.remove(e.getChannel()),;
}
@Override
public,void,messageReceived(ChannelHandlerContext,ctx,,MessageEvent,e,XmlDocument,d),{
MessageEvent,s,=,e,;,,,,,,,,
//,Convert,to,a,String,first.,,,,,,,,
XmlDocument,doc,=,d,;//new,XmlDocument(),;
//doc.LoadXml((String)message),;
//String,cAction,=,doc.DocumentElement.ChildNodes[0].Attributes["action"].Value,;
String,cAction,=,doc.getDocumentElement().getChildren().get(0).getAttribute("action").getValue(),;
InetSocketAddress,remoteAddress,=,(InetSocketAddress)s.getChannel().getRemoteAddress(),;
	String,strIpPort,=,remoteAddress.getAddress().getHostAddress(),+,":",+,String.valueOf(remoteAddress.getPort()),;
//
//,,,,,,,,//create,item
SessionMessage,item,=,new,SessionMessage(e,,doc,,false,,false),;
//
//,,,,,,,,//save
ChChessLPU.getInstance().getmsgList().Opp(QueueMethod.Add,,item),;
//
//,,,,,,,,//
if,(cAction.equals(ClientAction.heartBeat))
{
//???
}
else
{
//log
Log.WriteStrByRecv(cAction,,strIpPort),;
}
}
@Override
public,void,exceptionCaught(ChannelHandlerContext,ctx,,ExceptionEvent,e),{
e.getCause().printStackTrace(),;
e.getChannel().close(),;
}
@Override
public,void,sessionOpened(),{
//throw,new,UnsupportedOperationException("Not,supported,yet."),;,//To,change,body,of,generated,methods,,choose,Tools,|,Templates.
}
@Override
public,void,sessionClosed(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
try
{
Channel,c,=,e.getChannel(),;
InetSocketAddress,remoteAddress,=,(InetSocketAddress)c.getRemoteAddress(),;
String,strIpPort,=,remoteAddress.getAddress().getHostAddress(),+,":",+,String.valueOf(remoteAddress.getPort()),;
XmlDocument,doc,=,new,XmlDocument(),;
//
String,packeXml,=,"<msg,t='sys'><body,action='sessionClosed'>",+,strIpPort,+,"</body></msg>",;
doc.LoadXml(packeXml),;
//create,item
SessionMessage,item,=,new,SessionMessage(e,,doc,,false,,false),;
//save
ChChessLPU.getInstance().getmsgList().Opp(QueueMethod.Add,,item),;
}
catch,(JDOMException,|,IOException,|RuntimeException,exd)
{
Log.WriteStrByException("ChChessGameClientHandler",,"sessionClosed",,exd.getMessage()),;
},
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.wdqipai.server.handler,;
import,System.Xml.XmlDocument,;
import,java.net.InetSocketAddress,;
import,net.silverfoxserver.core.array.QueueMethod,;
import,net.silverfoxserver.core.log.Log,;
import,net.silverfoxserver.core.protocol.ClientAction,;
import,net.silverfoxserver.core.service.IoHandler,;
import,net.silverfoxserver.core.socket.SessionMessage,;
import,net.wdqipai.server.ChChessLogic,;
import,net.wdqipai.server.ChChessLPU,;
import,org.jboss.netty.channel.ChannelEvent,;
import,org.jboss.netty.channel.ChannelHandlerContext,;
import,org.jboss.netty.channel.ChannelStateEvent,;
import,org.jboss.netty.channel.ExceptionEvent,;
import,org.jboss.netty.channel.MessageEvent,;
import,org.jboss.netty.channel.group.ChannelGroup,;
import,org.jboss.netty.channel.group.DefaultChannelGroup,;
/**
*
*,@author,FUX
*/
public,class,ChChessRCClientHandler,implements,IoHandler{
static,final,ChannelGroup,channels,=,new,DefaultChannelGroup(),;
public,void,handleUpstream(ChannelHandlerContext,ctx,,ChannelEvent,e){
if,(e,instanceof,ChannelStateEvent),{
System.err.println(e),;
}
//super.handleUpstream(ctx,,e),;
}
public,void,sessionCreated(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
//,Get,the,SslHandler,in,the,current,pipeline.
//,We,added,it,in,SecureChatPipelineFactory.
//final,SslHandler,sslHandler,=,ctx.getPipeline().get(SslHandler.class),;
//,Get,notified,when,SSL,handshake,is,done.
//,ChannelFuture,handshakeFuture,=,sslHandler.handshake(),;
//handshakeFuture.addListener(new,Greeter(sslHandler)),;
}
public,void,channelDisconnected(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
//,Unregister,the,channel,from,the,global,channel,list
//,so,the,channel,does,not,receive,messages,anymore.
channels.remove(e.getChannel()),;
}
@Override
public,void,messageReceived(ChannelHandlerContext,ctx,,MessageEvent,e,XmlDocument,d),{
MessageEvent,s,=,e,;,,,,,,,,
//,Convert,to,a,String,first.,,,,,,,,
XmlDocument,doc,=,d,;//new,XmlDocument(),;
//doc.LoadXml((String)message),;
//String,cAction,=,doc.DocumentElement.ChildNodes[0].Attributes["action"].Value,;
String,cAction,=,doc.getDocumentElement().getChildren().get(0).getAttribute("action").getValue(),;
InetSocketAddress,remoteAddress,=,(InetSocketAddress)s.getChannel().getRemoteAddress(),;
	String,strIpPort,=,remoteAddress.getAddress().getHostAddress(),+,":",+,String.valueOf(remoteAddress.getPort()),;
//
//,,,,,,,,//create,item
SessionMessage,item,=,new,SessionMessage(e,,doc,,false,,true),;
//
//,,,,,,,,//save
ChChessLPU.getInstance().getmsgList().Opp(QueueMethod.Add,,item),;
//
//,,,,,,,,//
if,(cAction.equals(ClientAction.heartBeat))
{
//???
}
else
{
//log
Log.WriteStrByRecv(cAction,,strIpPort),;
}
}
@Override
public,void,exceptionCaught(ChannelHandlerContext,ctx,,ExceptionEvent,e),{
e.getCause().printStackTrace(),;
e.getChannel().close(),;
}
@Override
public,void,sessionOpened(),{
//throw,new,UnsupportedOperationException("Not,supported,yet."),;,//To,change,body,of,generated,methods,,choose,Tools,|,Templates.
}
@Override
public,void,sessionClosed(ChannelHandlerContext,ctx,,ChannelStateEvent,e),{
//throw,new,UnsupportedOperationException("Not,supported,yet."),;,//To,change,body,of,generated,methods,,choose,Tools,|,Templates.
ChChessLogic.getInstance().RCConnector.retryConnect(),;
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,ddzserver,;
import,net.silverfoxserver.core.log.LoggerLvl,;
/**
*
*,@author,ACER-FX
*/
public,class,Globals,{
/**
*,
*,
*/
public,static,String,os,;
/**,
*/
public,static,int,currentLogLvl,=,LoggerLvl.ALL2,;
/**,
	,
*/
public,static,String,payUser,=,"",;
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,ddzserver,;
import,System.Console,;
import,System.ConsoleColor,;
import,System.Xml.XmlDocument,;
import,System.IO.Path,;
import,System.Xml.XmlNode,;
import,System.Xml.XmlNodeList,;
import,java.io.IOException,;
import,java.sql.SQLException,;
import,java.util.List,;
import,java.util.Locale,;
import,java.util.logging.Level,;
import,java.util.logging.Logger,;
import,net.silverfoxserver.core.filter.FilterWordManager,;
import,net.silverfoxserver.core.log.Log,;
import,net.silverfoxserver.core.model.ITabModel,;
import,net.silverfoxserver.core.socket.SocketAcceptor,;
import,net.silverfoxserver.core.socket.SocketConnector,;
import,net.silverfoxserver.core.util.SR,;
import,net.silverfoxserver.DdzLPU,;
import,net.silverfoxserver.DdzLogic,;
import,net.silverfoxserver.DdzRCLogic,;
import,net.silverfoxserver.extfactory.TabModelFactory,;
import,net.silverfoxserver.extlogic.PokerName,;
import,net.silverfoxserver.extmodel.TabModelByDdz,;
import,net.silverfoxserver.handler.DdzGameClientHandler,;
import,net.silverfoxserver.handler.DdzRCClientHandler,;
import,org.jdom2.Document,;
import,org.jdom2.Element,;
import,org.jdom2.JDOMException,;
/**
*
*,@author,ACER-FX
*/
public,class,Program,{
//??????,???????
public,static,final,String,GAME_NAME,=,"Ddz",;
/**
*,@param,args,the,command,line,arguments
*/
public,static,void,main(String[],args),throws,IOException,{
try
{
//copy,right
System.out.println("wdmir.com,,,2003-2015"),;
System.out.println("www.silverFoxServer.net,2009-2015"),;
//os,,,,,,,,,,,,
String,os,=,System.getProperty("os.name"),;
Globals.os,=,os,;,,,,,,,,,,,,
Console.WriteLine("[OS],",+,os),;,,
//??
//test
//"zh-HK",;
Locale,machine,=,Locale.getDefault(),;
String,lang,=,machine.getLanguage(),+,"-",+,machine.getCountry(),;//"zh-CN",;,//,System.Globalization.CultureInfo.InstalledUICulture.Name,;
SR.init(lang),;
//log
Log.init(GAME_NAME,0),;
//3.1??,-,????,,,,,,,,,,,,,,,,
//Console.Title,=,SR.GetString(SR.Win_Title,,SR.Ddz_displayName,,"3.2",,"2014/12/26"),;,//"2014/2/10"),;
//??????????
//Console.ForegroundColor,=,ConsoleColor.Green,;
//Console.ResetColor(),;
//Console.Clear(),;
//
//GameGlobals.GAME_NAME,=,GAME_NAME,;
//Console.WriteLine("[Boot],",+,Globals.svrName,+,",Server"),;
System.out.println(SR.GetString(SR.getBootSvr(),,SR.getDdz_displayName())),;
//-----------------------------------------------------------------
//??xml??
XmlDocument,configDoc,=,new,XmlDocument(),;
//?????????(???????????)????????
//string,str,=,System.Environment.CurrentDirectory,;
//????????????,?????,?????????????
//
String,configFileName,=,"DdzServerConfig.xml",;
//
String,ApplicationBase,=,"",;//System.getProperty("user.dir"),;
if(os.equals("Linux"))
{
//?Linux???????,????jar?????
String,javaClassPath,=,System.getProperty("java.class.path"),;
ApplicationBase,=,javaClassPath.substring(0,
javaClassPath.lastIndexOf("/")
),;
}else{
ApplicationBase,=,System.getProperty("user.dir"),;
}
//,,,,,,,,,,,,
String,configFileFullPath,=,Path.Combine(ApplicationBase,,configFileName),;
//
//Console.WriteLine("[Load,File],",+,System.AppDomain.CurrentDomain.SetupInformation.ApplicationBase,+,configFileName),;
System.out.println(SR.GetString(SR.getLoadFile(),,configFileFullPath)),;
configDoc.Load(configFileFullPath),;
//IP??
XmlNode,node,=,configDoc.SelectSingleNode("/www.wdmir.net/group/main-server"),;
if,(null,==,node)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),"/www.wdmir.net/group/main-server")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
String,ipAdr,=,node.ChildNodes()[0].getText(),;
int,port,=,Integer.parseInt(node.ChildNodes()[1].getText()),;
//????
XmlNode,tabNode,=,configDoc.SelectSingleNode("/www.wdmir.net/group/main-server/tabList"),;
//
int,tabNum,=,tabNode.ChildNodes().length,;
java.util.ArrayList<ITabModel>,tabList,=,new,java.util.ArrayList<ITabModel>(),;
int,k,=,0,;
//????
int,j,=,0,;
//ChildNodes
int,index,=,0,;
for,(k,=,0,;k,<,tabNum,;k++)
{
TabModelByDdz,Tab,=,(TabModelByDdz)TabModelFactory.Create(k),;
//??????????
Element,e,=,tabNode.ChildNodes()[index],;
Tab.setTabName(e.getAttributeValue("n")),;
int,size,=,e.getChildren().size(),;
Tab.setRoomCount(size),;
//????
Tab.setRoomG(Integer.parseInt(e.getAttributeValue("g"))),;
//?????????
Tab.setRoomCarryG(Integer.parseInt(e.getAttributeValue("carryG"))),;
//????
Tab.setRoomCostG(Float.parseFloat(e.getAttributeValue("costG"))),;
//????????
Tab.setTabAutoMatchMode(Integer.parseInt(e.getAttributeValue("autoMatchMode"))),;
//???????
Tab.setQuickMode(Integer.parseInt(e.getAttributeValue("quickMode"))),;
//??????Logic????,????2???,
//????1???,???????????
if,(1,==,Tab.getTabAutoMatchMode(),&&,1,==,Tab.getRoomCount())
{
System.out.println(SR.GetString(SR.getRoom_auto_match_mode_and_room_num_less_2(),,"Tab,",+,(new,Integer(index)).toString())),;
}
int,roomCount,=,Tab.getRoomCount(),;
for,(j,=,0,;,j,<,roomCount,;,j++)
{
Tab.getRoomName()[j],=,e.getChildren().get(j).getAttributeValue("n"),;
}
//check
//
if,(0,>=,Tab.getRoomCount())
{
System.out.println(SR.GetString(SR.getRoom_num_zero(),,"Tab,",+,(new,Integer(index)).toString())),;
}
if,(1,<=,Tab.getRoomCostG())
{
System.out.println(SR.GetString(SR.getRoom_costG_more_than_1(),,"Tab,",+,(new,Integer(index)).toString())),;
Tab.setRoomCostG(0.0f),;
}
//
tabList.add(Tab),;
index++,;
}
//????????????,????????
//int,maxOnlinePeople,=,int.Parse(node.ChildNodes()[7].getText()),;,,,,,,,,,,,,,,,
//if,(0,==,maxOnlinePeople)
//{
//,,,,Console.WriteLine("??:???????????????0,???????????"),;
//}
//???
String,allowAccessFromDomain,=,node.ChildNodes()[4].getText(),;
if,(allowAccessFromDomain.equals(""))
{
allowAccessFromDomain,=,"*",;
}
//??????
String,allowPlayerGlessThanZeroOnGameOverStr,=,node.ChildNodes()[5].getText(),;
boolean,allowPlayerGlessThanZeroOnGameOver,=,false,;
if,(allowPlayerGlessThanZeroOnGameOverStr.toLowerCase().equals("no"))
{
allowPlayerGlessThanZeroOnGameOver,=,false,;
//Console.WriteLine("??:?????????????"),;
System.out.println(SR.GetString(SR.getAllow_playerG_less_than_zero_on_game_over())),;
}
else
{
allowPlayerGlessThanZeroOnGameOver,=,true,;
}
//????
int,logLevel,=,Integer.parseInt(node.ChildNodes()[6].getText()),;
if,(0,==,logLevel)
{
//GameGlobals.logLvl,=,LoggerLvl.CLOSE0,;
}
else,if,(1,==,logLevel)
{
//GameGlobals.logLvl,=,LoggerLvl.NORMAL1,;
}
else
{
logLevel,=,2,;
//GameGlobals.logLvl,=,LoggerLvl.ALL2,;
}
//
//Logger.init(GameGlobals.GAME_NAME,,GameGlobals.logLvl),;
//cost???????????
String,costUser,=,node.ChildNodes()[7].getText(),;
if,(costUser.equals(""))
{
costUser,=,"admin",;
//Console.WriteLine("??:????????????,????admin"),;
System.out.println(SR.GetString(SR.getCost_default_set_to_admin())),;
}
//
String,payUser,=,Globals.payUser,=,node.ChildNodes()[8].getText(),;
//
int,runAwayMultiG,=,Integer.parseInt((node.ChildNodes()[9].getText())),;
int,reconnectionTime,=,Integer.parseInt((node.ChildNodes()[10].getText())),;
//15???????????
//??????????
if,(reconnectionTime,<,30)
{
System.out.println(SR.getRoom_reconnection_time_less_than_30()),;
reconnectionTime,=,30,;
}
int,everyDayLogin,=,Integer.parseInt((node.ChildNodes()[11].getText())),;
//????
XmlNode,omNode,=,configDoc.SelectSingleNode("/www.wdmir.net/group/main-server/other-modules/turn-over-a-card"),;
if,(null,==,omNode)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),,"/www.wdmir.net/group/main-server/other-modules/turn-over-a-card")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
int,turnOver_a_Card_module_run,=,Integer.parseInt(omNode.getAttributeValue("run")),;
int,turnOver_a_Card_module_g1,=,Integer.parseInt(omNode.getAttributeValue("g1")),;
int,turnOver_a_Card_module_g2,=,Integer.parseInt(omNode.getAttributeValue("g2")),;
int,turnOver_a_Card_module_g3,=,Integer.parseInt(omNode.getAttributeValue("g3")),;
float,turnOver_a_Card_costG,=,Float.parseFloat(omNode.getAttributeValue("costG")),;
if,(0,==,turnOver_a_Card_module_run)
{
//??
}
else
{
System.out.println(SR.GetString(SR.getLoadModulesAndStart(),,SR.getTurnOver_a_Card_module_displayName())),;
}
//
if,(0,>=,turnOver_a_Card_module_g1)
{
System.out.println(SR.GetString(SR.getTurnOver_a_Card_module_g_zero(),,"g1")),;
}
if,(0,>=,turnOver_a_Card_module_g2)
{
System.out.println(SR.GetString(SR.getTurnOver_a_Card_module_g_zero(),,"g2")),;
}
if,(0,>=,turnOver_a_Card_module_g3)
{
System.out.println(SR.GetString(SR.getTurnOver_a_Card_module_g_zero(),,"g3")),;
},,,,,,,,,,,,
//
XmlNode,rcNode,=,configDoc.SelectSingleNode("/www.wdmir.net/group/main-server/record-server"),;
if,(null,==,rcNode)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),"/www.wdmir.net/group/main-server/record-server")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
String,connect_ipAdr2,=,rcNode.ChildNodes()[0].getText(),;
int,connect_port2,=,Integer.parseInt(rcNode.ChildNodes()[1].getText()),;
String,proof,=,rcNode.ChildNodes()[2].getText(),;
//Console.WriteLine("[Load,File],OK"),;
System.out.println(SR.GetString(SR.getLoadFileSuccess())),;
//---------------,??????????,begin,---------------,
XmlDocument,filterWordDoc,=,new,XmlDocument(),;
String,filterWordFileFullPath,=,Path.Combine(ApplicationBase,,"FilterWordConfig.xml"),;
filterWordDoc.Load(filterWordFileFullPath),;
Console.WriteLine(
SR.GetString(SR.getLoadFile(),filterWordFileFullPath)
),;
XmlNode,filterLvl,=,filterWordDoc.SelectSingleNode("/www.wdmir.net/pubmsg-filter-level"),;
if,(null,==,filterLvl)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),"/www.wdmir.net/pubmsg-filter-level")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
XmlNode,filterNode,=,filterWordDoc.SelectSingleNode("/www.wdmir.net/pubmsg-filter-word"),;
if,(null,==,filterNode)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),,"/www.wdmir.net/pubmsg-filter-word")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
XmlNode,filterMakeupNode,=,filterWordDoc.SelectSingleNode("/www.wdmir.net/pubmsg-filter-makeup-word"),;
if,(null,==,filterMakeupNode)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
System.out.println(SR.GetString(SR.getCan_not_find_node(),,"/www.wdmir.net/pubmsg-filter-makeup-word")),;
Console.ForegroundColor,=,ConsoleColor.Green,;
}
FilterWordManager.init(filterLvl.InnerText(),,
filterNode.InnerText(),,
filterMakeupNode.InnerText()),;
//---------------,??????????,end,---------------,
System.out.println(SR.GetString(SR.getLoadFileSuccess())),;
//??????
DdzLogic.getInstance().init(tabNode,tabList,,costUser,,allowPlayerGlessThanZeroOnGameOver,,runAwayMultiG,,reconnectionTime,,everyDayLogin),;
//?????
DdzLogic.getInstance().init_modules(costUser,,turnOver_a_Card_module_run,,turnOver_a_Card_module_g1,,turnOver_a_Card_module_g2,,turnOver_a_Card_module_g3,,turnOver_a_Card_costG),;
DdzRCLogic.getInstance().init(DdzLogic.getInstance()),;
//
DdzLPU.getInstance().init(),;
//?????DB?Connector,????????
SocketConnector,connector,=,new,SocketConnector(proof),;
connector.setHandler(new,DdzRCClientHandler()),;
//
//SocketAcceptor,acceptor,=,new,SocketAcceptor(payUser,,GAME_NAME,,allowAccessFromDomain,,true),;
SocketAcceptor,acceptor,=,new,SocketAcceptor(GAME_NAME),;,
acceptor.setHandler(new,DdzGameClientHandler(),true),;
//?????connector
//????connector?send??
DdzLogic.getInstance().setRCConnector(connector),;
DdzLogic.getInstance().setClientAcceptor(acceptor),;
//????????????????
connector.connect("127.0.0.1",,9500),;
//????????
acceptor.bind(port,,false),;
//??post,builder,????ReadLine
//,,,,,,,,,,,,,,,,String,line,;
//,,,,,,,,,,,,,,,,BufferedReader,in,=,new,BufferedReader(new,InputStreamReader(System.in)),;
//,,,,,,,,,,,,,,,,while,(!(line,=,in.readLine()).equals(SR.Shutdown))
//,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,if,(line.equals(null))
//,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,//break,;
//,,,,,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,,,,,else,if,(line.equals("shutdown"))
//,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,break,;
//
//,,,,,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,,,,,else,if,(line.equals("clear"))
//,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,Console.Clear(),;
//
//,,,,,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,,,,,else,if,(line.equals("port"))
//,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,System.out.println(port),;
//
//,,,,,,,,,,,,,,,,,,,,,,,,}
//,,,,,,,,,,,,,,,,,,,,,,,,else
//,,,,,,,,,,,,,,,,,,,,,,,,{
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,System.out.println("unknow,command"),;
//,,,,,,,,,,,,,,,,,,,,,,,,}
//
//,,,,,,,,,,,,,,,,,,,,,,,,//Console.WriteLine("run,command:",+,line),;
//,,,,,,,,,,,,,,,,}
//Console.ReadLine(),;
}
catch,(IOException,|,JDOMException,|,RuntimeException,exd)
{
Console.ForegroundColor,=,ConsoleColor.Red,;
Log.WriteStr2(SR.GetString(SR.getGame_svr_start_failed(),,exd.getMessage())),;
Console.ForegroundColor,=,ConsoleColor.Green,;
System.out.println(SR.GetString(SR.getGame_svr_failed_help())),;
System.out.println("email:521266750@qq.com"),;
System.in.read(),;
}
}
}
/*
*,SilverFoxServer:,massive,multiplayer,game,server,for,Flash,,...
*,VERSION:3.0
*,PUBLISH,DATE:2015-9-2,
*,GITHUB:github.com/wdmir/521266750_qq_com
*,UPDATES,AND,DOCUMENTATION,AT:,http://www.silverfoxserver.net
*,COPYRIGHT,2009-2015,SilverFoxServer.NET.,All,rights,reserved.
*,MAIL:521266750@qq.com
*/
package,net.silverfoxserver,;
import,System.Xml.XmlDocument,;
import,System.Xml.XmlNode,;
import,System.Xml.XmlNodeList,;
import,ddzserver.Globals,;
import,ddzserver.Program,;
import,java.io.IOException,;
import,java.io.UnsupportedEncodingException,;
import,java.time.LocalDate,;
import,java.util.concurrent.ConcurrentHashMap,;
import,net.silverfoxserver.core.filter.FilterWordManager,;
import,net.silverfoxserver.core.log.Log,;
import,net.silverfoxserver.core.logic.ToSitDownStatus,;
import,net.silverfoxserver.core.model.IChairModel,;
import,net.silverfoxserver.core.model.IRoomModel,;
import,net.silverfoxserver.core.model.IRuleModel,;
import,net.silverfoxserver.core.model.ITabModel,;
import,net.silverfoxserver.core.model.IUserModel,;
import,net.silverfoxserver.core.protocol.RCClientAction,;
import,net.silverfoxserver.core.protocol.ServerAction,;
import,net.silverfoxserver.core.server.GameLPU,;
import,net.silverfoxserver.core.server.GameLogicServer,;
import,net.silverfoxserver.core.socket.AppSession,;
import,net.silverfoxserver.core.socket.SessionMessage,;
import,net.silverfoxserver.core.socket.XmlInstruction,;
import,net.silverfoxserver.core.util.MD5ByJava,;
import,net.silverfoxserver.core.util.RandomUtil,;
import,net.silverfoxserver.core.service.Mail,;
import,net.silverfoxserver.core.util.SR,;
import,net.silverfoxserver.extfactory.RoomModelFactory,;
import,net.silverfoxserver.extfactory.RuleModelFactory,;
import,net.silverfoxserver.extfactory.UserModelFactory,;
import,net.silverfoxserver.extmodel.AutoMatchRoomModel,;
import,net.silverfoxserver.extmodel.RoomModelByDdz,;
import,net.silverfoxserver.extmodel.RoomModelByToac,;
import,net.silverfoxserver.extmodel.RoomStatusByDdz,;
import,net.silverfoxserver.extmodel.TabModelByDdz,;
import,org.jdom2.Element,;
import,org.jdom2.JDOMException,;
/**
*
*,@author,FUX
*/
public,class,DdzLogic,extends,GameLogicServer
{
public,final,String,CLASS_NAME,=,"DdzLogic",;
/**
*,??
*,
*/
private,static,DdzLogic,_instance,=,null,;
public,static,DdzLogic,getInstance()
{
if(null,==,_instance)
{
_instance,=,new,DdzLogic(),;
}
return,_instance,;
},,	
/**
*,?????
*,
*,@param,tabNode_
*,@param,tabList_
*,@param,costUser
*,@param,allowGlessThanZero
*,@param,runAwayMultiG
*,@param,reconnectionTime
*,@param,everyDayLogin,
*/
public,void,init(XmlNode,tabNode_,
java.util.ArrayList<ITabModel>,tabList_,,
String,costUser,,
boolean,allowGlessThanZero,,
int,runAwayMultiG,,
int,reconnectionTime,,
int,everyDayLogin)
{
//
allowPlayerGlessThanZeroOnGameOver,=,allowGlessThanZero,;
//
initTabList(tabList_),;
//
initRoomList(tabNode_,tabList_,,costUser,,runAwayMultiG,,reconnectionTime,,everyDayLogin),;
}
public,void,initTabList(java.util.ArrayList<ITabModel>,tabList_)
{
int,tabNum,=,tabList_.size(),;
//
if,(null,==,tabList)
{
tabList,=,new,ConcurrentHashMap(),;,
}
//
for,(int,i,=,0,;,i,<,tabNum,;,i++)
{
tabList.put(tabList_.get(i).getId(),,tabList_.get(i)),;
}
}
/**,
???????
??????????
*,@param,tabNode_
*,@param,tabList_
*,@param,costUser
*,@param,runAwayMultiG
*,@param,reconnectionTime
*,@param,everyDayLogin
*/
public,void,initRoomList(XmlNode,tabNode_,
java.util.ArrayList<ITabModel>,tabList_,,
String,costUser,,
int,runAwayMultiG,,
int,reconnectionTime,,
int,everyDayLogin)
{
try
{
if,(null,==,roomList)
{
//0.1f,???????
//?????????????
roomList,=,new,ConcurrentHashMap(),;,
}
//-------------------------------------------
//????
Element[],ChildNodes,=,tabNode_.ChildNodes(),;
int,i,=,0,;
int,j,=,0,;
int,tabNum,=,tabNode_.ChildNodes().length,;
totalRoom,=,0,;
for(i=0,;i<tabNum,;i++)
{
int,tabIndex,,=,0,;
int,roomG,=,1,;
int,roomCarryG,=,1,;
float,roomCostG,=,0.0f,;,//??cost???0.0f
String,roomCostU,=,costUser,;
String,roomCostUid,=,costUser.equals(""),?,"":getMd5Hash(costUser),;
int,tabAutoMatchMode,=,0,;
int,tabQuickRoomMode,=,0,;
TabModelByDdz,tab,=,(TabModelByDdz)tabList_.get(i),;
tabIndex,,,,,,,,,=,tab.getId(),;
roomG,,,,,,,,,,,,=,tab.getRoomG(),;
roomCarryG,,,,,,,=,tab.getRoomCarryG(),;
roomCostG,,,,,,,,=,tab.getRoomCostG(),;
tabAutoMatchMode,=,tab.getTabAutoMatchMode(),;
tabQuickRoomMode,=,tab.getTabQuickRoomMode(),;
int,jLen,=,tab.getRoomCount(),;
for,(j,=,0,;,j,<,jLen,;,j++)
{
totalRoom++,;
IRoomModel,room,;
IRuleModel,rule,=,RuleModelFactory.Create(),;
room,=,RoomModelFactory.Create(totalRoom,,tabIndex,,rule),;
room.setName(tabList_.get(i).getRoomName()[j]),;
//refresh,room,gold,point,config
room.setDig(roomG),;
room.setCarryg(roomCarryG),;
room.setCostg(roomCostG,,roomCostU,roomCostUid),;
room.setTabAutoMatchMode(tabAutoMatchMode),;
room.setTabQuickRoomMode(tabQuickRoomMode),;
//allowPlayerGlessThanZeroOnGameOver
room.setAllowPlayerGlessThanZeroOnGameOver(allowPlayerGlessThanZeroOnGameOver),;
//
room.setRunAwayMultiG(runAwayMultiG),;
room.setReconnectionTime(reconnectionTime),;
room.setEveryDayLogin(everyDayLogin),;
String,roomPwd,=,ChildNodes[i].getChildren().get(j).getAttributeValue("pwd"),;
room.setPwd(roomPwd),;,,,
roomList.put(room.getId(),,room),;
}
}
}
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"initRoomList",,exd.getMessage(),exd.getStackTrace()),;
}
}
/**,
@param,turnOver_a_Card_module_run
*/
public,void,init_modules(String,costUser_,,int,turnOver_a_Card_module_run_,,long,turnOver_a_Card_module_g1_,,long,turnOver_a_Card_module_g2_,,long,turnOver_a_Card_module_g3_,,float,turnOver_a_Card_module_costG)
{
DdzLogic_Toac.init(costUser_,,turnOver_a_Card_module_run_,,turnOver_a_Card_module_g1_,,turnOver_a_Card_module_g2_,,turnOver_a_Card_module_g3_,,turnOver_a_Card_module_costG),;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????????
/**,
????
????
@param,strIpPort
@return,
*/
public,boolean,logicHasUser(String,strIpPort)
{
if,(CLIENTAcceptor.hasUser(strIpPort))
{
return,true,;
}
//??????
//Log.WriteStrByArgument("DdzLogic",,"logicHasUser",,"strIpPort",,"????strIpPort:",+,strIpPort,+,"?????"),;
return,false,;
}
/**,
???????????
??,return,true????
@param,account
@return,
*/
public,boolean,logicHasUserByAccountName(String,accountName)
{
if,(CLIENTAcceptor.hasUserByAccountName(accountName))
{
Log.WriteStrByArgument("DdzLogic",,"logicHasUserByAccountName",,"accountName",,"?????????:",+,accountName),;
return,true,;
}
return,false,;
}
/**,
@param,id
*/
public,boolean,logicHasUserById(String,id)
{
if,(CLIENTAcceptor.hasUserById(id))
{
return,true,;
}
Log.WriteStrByArgument(CLASS_NAME,,"logicHasUserById",,"id",,"????id:",+,id,+,"?????"),;
return,false,;
}
/**,
?????
@param,roomId
@return,
*/
public,boolean,logicHasRoom(int,roomId)
{
if,(roomList.containsKey(roomId))
{
return,true,;
}
//Log.WriteStrByArgument("DdzLogic",,"logicHasRoom",,"roomId",,"????roomId:",+,roomId.ToString(),+,"???"),;
return,false,;
}
public,boolean,logicHasTab(int,tabIndex)
{
if,(tabList.containsKey(tabIndex))
{
return,true,;
}
Log.WriteStrByArgument("DdzLogic",,"logicHasTab",,"tabIndex",,"????tabIndex:",+,(new,Integer(tabIndex)).toString()),;
return,false,;
}
/**,
?????????
@param,strIpPort
@param,roomId
@return,
*/
public,boolean,logicHasUserInRoom(String,strIpPort,,int,roomId)
{
//?????
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
//????
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
//?????????
if,(room.hasPeople(user))
{
return,true,;
},//end,if
},//end,if
},//end,if
//Log.WriteStrByArgument("DdzLogic",,"logicHasUserInRoom",,"roomId",,"?roomId:",+,roomId.ToString(),+,"???????,",+,strIpPort,+,",???"),;
return,false,;
}
/**,
@param,strIpPort
@return,
*/
public,boolean,logicQueryUserInRoom(String,strIpPort)
{
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
boolean,hasUserInRoom,=,logicQueryUserInRoom(strIpPort,,room.getId()),;
if,(hasUserInRoom)
{
return,true,;
}
}
return,false,;
}
/**,
?logicHasUserInRoom??????,?????Log.WriteStrByArgument
?????????????
@param,strIpPort
@param,roomId
@return,
*/
public,boolean,logicQueryUserInRoom(String,strIpPort,,int,roomId)
{
//?????
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
//????
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
//?????????
if,(room.hasPeople(user))
{
return,true,;
},//end,if
},//end,if
},//end,if
return,false,;
}
/**,
?????????,hasUser
@param,strIpPort
@return,
*/
public,IUserModel,logicGetUser(String,strIpPort)
{
return,CLIENTAcceptor.getUser(strIpPort),;
}
public,IUserModel,logicGetUserById(String,id)
{
return,CLIENTAcceptor.getUserById(id),;
}
/**,
???????
@param,roomId
@param,pos
@return,
*/
public,boolean,logicHasIdleChair(int,roomId)
{
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
if,(room.getChairCount(),>,room.getSomeBodyChairCount())
{
return,true,;
}
else
{
return,false,;
},//end,if
},//end,if
return,false,;
}
/**,
????????,???????????
@param,roomId
@return,
*/
public,int[],logicHasIdleMatchChair(int,roomId)
{
int[],res,=,new,int[],{0,,0},;
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
if,(room.getChairCount(),>,room.getSomeBodyChairCount())
{
res[0],=,1,;,//true
res[1],=,room.getChairCount(),-,room.getSomeBodyChairCount(),;
return,res,;
}
else
{
res[0],=,0,;,//false
res[1],=,0,;
return,res,;
},//end,if
},//end,if
return,res,;
}
/**,
??????
????????,hasRoom,??????????
@param,roomId
@return,
*/
public,IRoomModel,logicGetRoom(int,roomId)
{
IRoomModel,room,=,(IRoomModel)roomList.get(roomId),;
return,room,;
}
public,ITabModel,logicGetTab(int,tabIndex)
{
ITabModel,tab,=,(ITabModel)tabList.get(tabIndex),;
return,tab,;
}
/**,
???????,?????
@return,
*/
public,String[],logicHasIdleChairAndSitDown(int,roomId,,String,strIpPort)//,,tangible.RefObject<ToSitDownStatus>,sitDownStatus)
{
String[],arr,={"",""},;
//???
if,(logicHasIdleChair(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
//??
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
boolean,isOk,=,false,;
//
if,(room.isWaitReconnection())
{
//if,(room.WaitReconnectionUser.Id,!=,user.Id)
if,(!room.getWaitReconnectionUser().getId().equals(user.getId()))
{
//sitDownStatus.argvalue,=,ToSitDownStatus.WaitReconnectioRoom5,;
//return,false,;
arr[0],=,Boolean.toString(false),;
arr[1],=,String.valueOf(net.silverfoxserver.core.logic.ToSitDownStatus.WaitReconnectioRoom5),;
return,arr,;
}
}
//
isOk,=,room.setSitDown(user,false),;
if,(isOk)
{
//sitDownStatus.argvalue,=,ToSitDownStatus.Success0,;
//return,true,;
arr[0],=,Boolean.toString(true),;
arr[1],=,String.valueOf(net.silverfoxserver.core.logic.ToSitDownStatus.Success0),;
return,arr,;
}
//sitDownStatus.argvalue,=,ToSitDownStatus.ProviderError3,;
//return,false,;
arr[0],=,Boolean.toString(false),;
arr[1],=,String.valueOf(ToSitDownStatus.ProviderError3),;
return,arr,;
},//end,if
}
else
{
//sitDownStatus.argvalue,=,ToSitDownStatus.NoIdleChair1,;
//return,false,;
arr[0],=,Boolean.toString(false),;
arr[1],=,String.valueOf(ToSitDownStatus.NoIdleChair1),;
return,arr,;
}
//sitDownStatus.argvalue,=,ToSitDownStatus.ProviderError3,;
//return,false,;
arr[0],=,Boolean.toString(false),;
arr[1],=,String.valueOf(ToSitDownStatus.ProviderError3),;
return,arr,;
}
/**,
????????,??1?????????
@param,roomId
@param,strIpPort
@param,sitDownStatus
@return,
*/
public,String[],logicHasIdleChairAndMatchSitDown(int,roomId,,int,matchLvl,,String,strIpPort,,boolean,chkSameIp)//,,tangible.RefObject<ToSitDownStatus>,sitDownStatus)
{
String[],arr,=,{"",""},;
//???
int[],matchRes,=,logicHasIdleMatchChair(roomId),;
//if,(boolean)(matchRes[0]),&&,matchLvl,==,matchRes[1])
if,(1,==,matchRes[0],&&,matchLvl,==,matchRes[1])
{
IRoomModel,room,=,logicGetRoom(roomId),;
//??
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
//---------------------------------------------
//test
//chkSameIp,=,false,;
if,(chkSameIp)
{
if,(room.hasSameIpPeople(user,true))
{
//sitDownStatus.argvalue,=,ToSitDownStatus.HasSameIpUserOnChair4,;
//return,false,;
arr[0],=,"false",;
arr[1],=,String.valueOf(ToSitDownStatus.HasSameIpUserOnChair4),;
return,arr,;
}
}
//chkWaitReconnection
if,(room.isWaitReconnection())
{
if,(!room.getWaitReconnectionUser().getId().equals(user.getId()))
{
//sitDownStatus.argvalue,=,ToSitDownStatus.WaitReconnectioRoom5,;
//return,false,;
arr[0],=,"false",;
arr[1],=,String.valueOf(ToSitDownStatus.WaitReconnectioRoom5),;
return,arr,;
}
}
//---------------------------------------------
boolean,isOk,=,room.setSitDown(user,false),;
if,(isOk)
{
//sitDownStatus.argvalue,=,ToSitDownStatus.Success0,;
//return,true,;
arr[0],=,"true",;
arr[1],=,String.valueOf(ToSitDownStatus.Success0),;
return,arr,;
}
//sitDownStatus.argvalue,=,ToSitDownStatus.ProviderError3,;
//return,false,;
arr[0],=,"false",;
arr[1],=,String.valueOf(ToSitDownStatus.ProviderError3),;
return,arr,;
},//end,if
}
else
{
//sitDownStatus.argvalue,=,ToSitDownStatus.NoIdleChair1,;
//return,false,;
arr[0],=,"false",;
arr[1],=,String.valueOf(ToSitDownStatus.NoIdleChair1),;
return,arr,;
}
//sitDownStatus.argvalue,=,ToSitDownStatus.ProviderError3,;
//return,false,;
arr[0],=,"false",;
arr[1],=,String.valueOf(ToSitDownStatus.ProviderError3),;
return,arr,;
}
/**,
????
@param,strIpPort
@param,username
*/
public,void,logicAddUser(String,strIpPort,,String,username)
{
}
/**,
????
@param,strIpPort
*/
public,void,logicRemoveUser(String,strIpPort)
{
CLIENTAcceptor.removeUser(strIpPort),;
}
/**,
????,???????
@param,strIpPort
*/
public,void,logicSessionClosed(String,strIpPort),throws,UnsupportedEncodingException,,JDOMException,,IOException
{
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
boolean,hasUserInRoom,=,false,;
//????????,,,,,,,,,,,,,,,,
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
hasUserInRoom,=,logicQueryUserInRoom(strIpPort,,room.getId()),;
if,(hasUserInRoom)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??????
int,leave_ChairId,=,room.getChair(user).getId(),;
//user,leave
String,leave_UserStrIpPort,=,user.getStrIpPort(),;
String,leave_saction,=,ServerAction.userGone,;
String,leave_ChairAndUserXml,=,room.getChair(leave_ChairId).toXMLString(),;
String,leave_ChairAndUserAnReconnectionTimeXml,=,leave_ChairAndUserXml,+,"<WaitReconnectionTime,Cur='",+,
String.valueOf(room.getCurWaitReconnectionTime()),+,"',Max='",+,
String.valueOf(room.getMaxWaitReconnectionTime()),+,"'/>",;
//?????,?????
if,(room.hasGamePlaying())
{
//?????????
if,(room.isWaitReconnection())
{
IUserModel,waitUser,=,room.getWaitReconnectionUser().clone(),;
String,waitUserIpPort,=,waitUser.getstrIpPort(),;
room.setWaitReconnection(null),;
//????
room.setGameOver(waitUser),;
room.setGameOver(user),;
//check,game,over
logicCheckGameOver(room.getId(),,strIpPort),;
//
room.setLeaveUser(waitUser),;
}
else
{
room.setWaitReconnection(user.clone()),;
//send
netTurnRoom(leave_UserStrIpPort,,room.getId(),,ServerAction.userWaitReconnectionRoomStart,,leave_ChairAndUserAnReconnectionTimeXml),;
}
}
//?????,????????????
//leave_ChairAndUserXml,=,room.getChair(leave_ChairId).toXMLString(),;
//save
room.setLeaveUser(user),;
//send
netTurnRoom(leave_UserStrIpPort,,room.getId(),,leave_saction,,leave_ChairAndUserXml),;
//log
Log.WriteStrByTurn(SR.getRoom_displayName(),+,String.valueOf(room.getId()),,strIpPort,,leave_saction),;
//??break,?????,????
//break,;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
},//end,for
//remove
logicRemoveUser(strIpPort),;
}
}
/**,
??????,??????,??????,????
@param,strIpPort,,,,,,,,
*/
public,void,logicLeaveRoom_Svr(String,strIpPort),throws,UnsupportedEncodingException
{
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
boolean,hasUserInRoom,=,false,;
//????????
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
hasUserInRoom,=,logicQueryUserInRoom(strIpPort,,room.getId()),;
if,(hasUserInRoom)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??????
//
int,leave_ChairId,=,room.getChair(user).getId(),;
//user,leave
String,leave_UserStrIpPort,=,user.getStrIpPort(),;
String,leave_saction,=,ServerAction.userGone,;
//
String,leave_ChairAndUserXml,;
//?????,????????????
leave_ChairAndUserXml,=,room.getChair(leave_ChairId).toXMLString(),;
//send
netTurnRoom(leave_UserStrIpPort,,room.getId(),,leave_saction,,leave_ChairAndUserXml),;
//log
Log.WriteStrByTurn(SR.getRoom_displayName(),,String.valueOf(room.getId()),,leave_saction),;
/*
if,(room.hasGamePlaying())
{,,,,,,,,,,,,,,,,,,,,,,,,,,,
room.setGameOver(user),;
logicCheckGameOver(room.getId(),,strIpPort),;
}
else
{
room.setLeaveUser(user),;
}*/
room.setLeaveUser(user),;
//?????,???return
//return,;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
},//end,for
}
}
/**,
????,???SessionClosed
??????session,???userList??
@param,strIpPort,,,,,,,,
*/
public,void,logicLeaveRoom(String,strIpPort),throws,JDOMException,,IOException
{
if,(logicHasUser(strIpPort))
{
IUserModel,user,=,logicGetUser(strIpPort),;
boolean,hasUserInRoom,=,false,;
//????????
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
hasUserInRoom,=,logicQueryUserInRoom(strIpPort,,room.getId()),;
if,(hasUserInRoom)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??????
//
int,leave_ChairId,=,room.getChair(user).getId(),;
//??????,?????
if,(room.hasGamePlaying())
{
room.setWaitReconnection(null),;
//????
room.setGameOver(user),;
//check,game,over
logicCheckGameOver(room.getId(),,strIpPort),;
}
//user,leave
String,leave_UserStrIpPort,=,user.getStrIpPort(),;
String,leave_saction,=,ServerAction.userGone,;
//
String,leave_ChairAndUserXml,;
//?????,????????????
leave_ChairAndUserXml,=,room.getChair(leave_ChairId).toXMLString(),;
//save
room.setLeaveUser(user),;
//send
netTurnRoom(leave_UserStrIpPort,,room.getId(),,leave_saction,,leave_ChairAndUserXml),;
//log
Log.WriteStrByTurn(SR.getRoom_displayName(),,String.valueOf(room.getId()),,leave_saction),;
//?????,???return
//return,;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
},//end,for
}
}
/**,
@param,roomId
@param,strIpPort
*/
public,void,logicCheckGameStartFirstChuPai(int,roomId,,String,strIpPort),throws,UnsupportedEncodingException
{
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
if,(room.hasGamePlaying("game_start_can_get_dizhu"))
{
//?????????
room.setGameStart("game_start_can_get_dizhu"),;
String,svrAction,=,ServerAction.gST,;
//?????xml??
String,roomXml,=,room.toXMLString(),;
//--------------------------------------------------------
java.util.ArrayList<IUserModel>,allPeople,=,room.getAllPeople(),;
for,(int,i,=,0,;,i,<,allPeople.size(),;,i++)
{
try
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??,???????????????
if,(netHasSession(allPeople.get(i).getstrIpPort()))
{
AppSession,userSession,=,netGetSession(allPeople.get(i).getstrIpPort()),;
//???????
//????????xml??
String,content,=,room.getFilterContentXml(allPeople.get(i).getstrIpPort(),,roomXml),;
Send(userSession,,XmlInstruction.fengBao(svrAction,,content)),;
},//end,if
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"logicCheckGameStartFirstChuPai",,exd.getMessage()),;
}
},//end,for
//??????
room.setGameStart("game_start_chupai"),;
//--------------------------------------------------------
//log
Log.WriteStrByMultiSend(svrAction,,strIpPort),;
},//end,if
},//end,if
}
/**,
@param,roomId
@param,strIpPort
*/
public,void,logicCheckGameStart(int,roomId),throws,JDOMException,,IOException
{
//
IRoomModel,room,=,logicGetRoom(roomId),;
boolean,allOk,=,room.hasAllReadyCanStart(),;
//loop,use
int,len,=,0,;
if,(allOk)
{
room.setGameStart(RoomStatusByDdz.GAME_START),;
//?????xml??
String,roomXml,=,room.toXMLString(),;
//????????Bar??????,???????
//?.dizhu????
//?.turn?????????
XmlDocument,doc,=,new,XmlDocument(),;
doc.LoadXml(roomXml),;
XmlNodeList,matchList,=,doc.SelectNodes("/room/match"),;
//String,dizhu,=,matchList.Item(0).getAttributeValue("dizhu"),;
String,dizhu,=,((Element)matchList.get(0)).getAttributeValue("dizhu"),;
//??
//matchList.Item(0).Attributes["dizhu"].Value,=,"",;
((Element)matchList.get(0)).getAttributeValue("dizhu"),;
//
//String,turn,=,matchList.Item(0).Attributes["turn"].Value,;
String,turn,=,((Element)matchList.get(0)).getAttributeValue("turn"),;
//trun??????????,????,????????,
boolean,chkTurn,=,true,;
//
if,(turn.equals(""))
{
chkTurn,=,false,;
}
if,(null,==,room.getChair(turn))
{
chkTurn,=,false,;
}
//
if,(!chkTurn)
{
turn,=,((RoomModelByDdz)((room,instanceof,RoomModelByDdz),?,room,:,null)).getTurnByCheckTurnNoOK(),;
//matchList.Item(0).Attributes["turn"].Value,=,turn,;
((Element)matchList.get(0)).setAttribute("turn",,turn),;
//
Log.WriteStrByWarn("??????????,????????"),;,
}
//set
roomXml,=,doc.OuterXml(),;
//
String,saction,=,ServerAction.gST,;
//????,??????????,????,??,,,,,,,,,,,,,,,,,,,,
//netSendRoom(roomId,,saction,,roomXml),;
//???????,netSendRoom???,netSendRoom???????,????
//???????
//--------------------------------------------------------
java.util.ArrayList<IUserModel>,allPeople,=,room.getAllPeople(),;
len,=,allPeople.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??,???????????????
if,(netHasSession(allPeople.get(i).getstrIpPort()))
{
AppSession,userSession,=,netGetSession(allPeople.get(i).getstrIpPort()),;
//???????
//????????xml??
String,content,=,room.getFilterContentXml(allPeople.get(i).getstrIpPort(),,roomXml),;
Send(userSession,,XmlInstruction.fengBao(saction,,content)),;
},//end,if
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
},//end,for
//--------------------------------------------------------
//log
Log.WriteStrByMultiSend(saction,,allPeople),;
},//end,if
}
/**,
@param,roomId
@param,strIpPort
*/
public,void,logicCheckGameOver_RoomClear(int,roomId,,String,strIpPort),throws,JDOMException,,IOException
{
if,(logicHasRoom(roomId))
{
IRoomModel,r,=,logicGetRoom(roomId),;
RoomModelByDdz,room,=,(RoomModelByDdz)((r,instanceof,RoomModelByDdz),?,r,:,null),;
if,(room.hasGameOver_RoomClear())
{
//reset
room.reset(),;
//
java.util.ArrayList<IChairModel>,list,=,room.findUser(),;
//
String,strIpPort_leave,;
for,(int,i,=,0,;i,<,list.size(),;i++)
{
strIpPort_leave,=,list.get(i).getUser().getStrIpPort(),;
AppSession,session_leave,=,netGetSession(strIpPort_leave),;
//
XmlDocument,doc_leave,=,new,XmlDocument(),;
doc_leave.LoadXml("<msg,t='sys'><body,action='leaveRoom',r='",+,
String.valueOf(room.getId()),+,"'><room,id='",+,
String.valueOf(room.getId()),+,"',/></body></msg>"),;
doorLeaveRoom_Svr(session_leave,,doc_leave),;
}
},//end,if
},//end,if
}
/**,
??????????
??????,
????????
*/
public,void,logicCheckGameOver(int,roomId,,String,strIpPort),throws,JDOMException,,IOException
{
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
if,(room.hasGameOver())
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????
String,game_result_saction,=,ServerAction.gOV,;
//?????????,?????MatchXml????
//?????
//
String,game_result_xml_rc,=,room.getMatchResultXmlByRc(),;
String,honor_result_xml_rc,=,((RoomModelByDdz)room).getHonorResultXmlByRc(),;
//----------????,??toXMLString??user?????????-----------------
//<room,id='30',name=''>
//<action,type='add',id='8ad8757baa8564dc136c1e07507f4a98,86985e105f79b95d6bc918fb45ec7727,',n='test3,test4',g='300'/>
//<action,type='sub',id='e3d704f3542b44a621ebed70dc0efe13',n='test5',g='600'/></room>
XmlDocument,doc,=,new,XmlDocument(),;
doc.LoadXml(game_result_xml_rc),;
XmlNode,node,=,doc.SelectSingleNode("/room"),;
int,len,=,node.ChildNodes().length,;
String[],sp,;
String[],g,;
String,type,;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??cache
java.util.ArrayList<IChairModel>,list,=,room.findUser(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
type,=,node.ChildNodes()[i].getAttributeValue("type"),;
//g,=,Convert.ToInt32(node.ChildNodes()[i].Attributes["g"].Value),;
g,=,node.ChildNodes()[i].getAttributeValue("g").split("[,]",,-1),;
sp,=,node.ChildNodes()[i].getAttributeValue("id").split("[,]",,-1),;
for,(int,j,=,0,;,j,<,sp.length,;,j++)
{
//
for,(int,k,=,0,;,k,<,list.size(),;,k++)
{
if,(sp[j].equals(list.get(k).getUser().getId()))
{
int,gTotal,=,list.get(k).getUser().getG(),;
if,(type.equals("add"))
{
gTotal,=,gTotal,+,Integer.parseInt(g[j]),;
}
else,if,(type.equals("sub"))
{
gTotal,=,gTotal,-,Integer.parseInt(g[j]),;
}
list.get(k).getUser().setG(gTotal),;
}
}
},//end,for
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//string,roomId,=,node.Attributes["id"].Value,;
//--------------------------------------------------------------------------------
String,game_result_xml,=,room.toXMLString(),;,//room.getMatchXml(),;
//send,?????,????,
Send(RCConnector.getSocket(),,XmlInstruction.DBfengBao(RCClientAction.updG,,game_result_xml_rc)),;
//
Log.WriteStrByTurn(SR.getRecordServer_displayName(),,RCConnector.getRemoteEndPoint(),,RCClientAction.updG),;
//????
Send(RCConnector.getSocket(),XmlInstruction.DBfengBao(RCClientAction.updHonor,honor_result_xml_rc)),;
//
Log.WriteStrByTurn(SR.getRecordServer_displayName(),,RCConnector.getRemoteEndPoint(),,RCClientAction.updHonor),;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,???????,check,ervery,day,login
//?-1??????
if(room.getEveryDayLogin(),>,0)
{
StringBuilder,su,=,new,StringBuilder(),;
su.append("<game,n='"),;
su.append(Program.GAME_NAME),;
su.append("',v='").append(room.getEveryDayLogin()),;
su.append("',r='").append(String.valueOf(room.getId())),;
su.append("'>"),;
for,(int,c,=,0,;,c,<,list.size(),;,c++)
{
su.append(list.get(c).getUser().toXMLString()),;
}
su.append("</game>"),;
Send(RCConnector.getSocket(),,XmlInstruction.DBfengBao(RCClientAction.chkEveryDayLoginAndGet,,su.toString())),;
Log.WriteStrByTurn(SR.getRecordServer_displayName(),,RCConnector.getRemoteEndPoint(),,RCClientAction.chkEveryDayLoginAndGet),;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//reset
room.reset(),;
//send
netSendRoom(roomId,,game_result_saction,,game_result_xml),;
//log
Log.WriteStrByMultiSend(game_result_saction,,strIpPort),;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
},//end,if
},//end,if
}
/**,
??????????????
@param,roomId
*/
private,boolean,logicChkRoomByDeadPeople(int,roomId)
{
boolean,hasDeadPeople,=,false,;
//?????
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
java.util.ArrayList<IChairModel>,chairs,=,room.findUser(),;
int,jLen,=,chairs.size(),;
for,(int,j,=,0,;,j,<,jLen,;,j++)
{
if,("",!=,chairs.get(j).getUser().getId())
{
String,strIpPort,=,chairs.get(j).getUser().getStrIpPort(),;
if,(!netHasSession(strIpPort))
{
hasDeadPeople,=,true,;
Log.WriteStrByWarn("??",+,(new,Integer(roomId)).toString(),+,"????"),;
break,;
}
}
}
},//end,if
return,hasDeadPeople,;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????????
/**,
@param,strIpPort
@return,
*/
public,boolean,netHasSession(String,strIpPort)
{
return,CLIENTAcceptor.hasSession(strIpPort),;
}
/**,
?????????,hasSession
@param,strIpPort
@return,
*/
public,AppSession,netGetSession(String,strIpPort)
{
return,CLIENTAcceptor.getSession(strIpPort),;
}
public,void,netTurnRoom(String,strIpPort,,int,roomId,,String,saction,,String,content,Boolean,All),throws,UnsupportedEncodingException
{
Boolean,s,;
if,(-1,!=,roomId)
{
IRoomModel,room,=,logicGetRoom(roomId),;
java.util.ArrayList<IUserModel>,allPeople,=,room.getAllPeople(),;
int,len,=,allPeople.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??
if(All)
{
s,=,true,;
}
else
{
s,=,!strIpPort.equals(allPeople.get(i).getstrIpPort()),;
}
if(s)
{
if,(netHasSession(allPeople.get(i).getstrIpPort()))
{
AppSession,userSession,=,netGetSession(allPeople.get(i).getstrIpPort()),;
Send(userSession,,XmlInstruction.fengBao(saction,,content)),;
},//end,if
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
},//end,for
}
else
{
//????
java.util.ArrayList<String>,all,=,CLIENTAcceptor.getUserList(),;
java.util.ArrayList<String>,allPeople,=,new,java.util.ArrayList<String>(),;
//?????????
int,jLen,=,all.size(),;
for,(int,j,=,0,;,j,<,jLen,;,j++)
{
if,(!logicQueryUserInRoom(all.get(j)))
{
allPeople.add(all.get(j)),;
}
}
//
int,len,=,allPeople.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??
if(All)
{
s,=,true,;
}
else
{,,,,,,,,,,,,,,,,,,,,,,,
s,=,!strIpPort.equals(allPeople.get(i)),;,,,,,,,,,,,,,,,,,,,
}
if,(s)
{
if,(netHasSession(allPeople.get(i)))
{
AppSession,userSession,=,netGetSession(allPeople.get(i)),;
Send(userSession,,XmlInstruction.fengBao(saction,,content)),;
},//end,if
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
},//end,for
}
}
/**,
??????????
@param,strIpPort
@param,roomId
@param,saction
@param,content
*/
public,void,netTurnRoom(String,strIpPort,,int,roomId,,String,saction,,String,content),throws,UnsupportedEncodingException
{
netTurnRoom(strIpPort,roomId,saction,content,false),;
}
/**,
???????????
@param,roomId
@param,saction
@param,content
*/
public,void,netSendRoom(int,roomId,,String,saction,,String,content),throws,UnsupportedEncodingException
{
if,(logicHasRoom(roomId))
{
IRoomModel,room,=,logicGetRoom(roomId),;
java.util.ArrayList<IUserModel>,allPeople,=,room.getAllPeople(),;
int,len,=,allPeople.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??
if,(netHasSession(allPeople.get(i).getstrIpPort()))
{
AppSession,userSession,=,netGetSession(allPeople.get(i).getstrIpPort()),;
Send(userSession,,XmlInstruction.fengBao(saction,,content)),;
},//end,if
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
},//end,for
}
}
/**,
????,????????,?????while
*/
public,void,netSendMail()
{
//???try?????????
//
String,svrAction,=,ServerAction.mVarsUpdate,;
//
for,(int,i,=,0,;,i,<,Mail().Length(),;,i++)
{
try
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????
Mail,m,=,Mail().GetMail(i),;
//??
if,(netHasSession(m.toUser.getStrIpPort()))
{
AppSession,userSession,=,netGetSession(m.toUser.getStrIpPort()),;
Send(userSession,,XmlInstruction.fengBao(svrAction,,m.toXMLString())),;
//
Mail().DelMail(i),;
i,=,0,;
}
else
{
//del
//,,,,,,,,,,,,,,Math.abs(new,java.util.Date().DayOfYear,-,m.dayOfYear),;
int,daySpan,=,Math.abs(LocalDate.now().getDayOfYear(),-,m.dayOfYear),;
//???????1?
if,(daySpan,>,0)
{
Mail().DelMail(i),;
i,=,0,;
}
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"netSendMail",,exd.getMessage()),;
}
},//end,for
}
/**,
??????
*/
public,void,TimedChkHeartBeat()
{
try
{
if,(null,==,CLIENTAcceptor)
{
return,;
}
//??????????,?????
java.util.ArrayList<String>,list,=,CLIENTAcceptor.getUserListByHeartBeat(true),;
int,len,=,list.size(),;
for,(int,i,=,0,;,i,<,len,;,i++)
{
if,(CLIENTAcceptor.hasSession(list.get(i)))
{
AppSession,session,=,CLIENTAcceptor.getSession(list.get(i)),;
//
CLIENTAcceptor.trigClearSession(session,,list.get(i)),;
}
}
}
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedChkHeartBeat",,exd.getMessage()),;
}
}
/**,
??????,????????
*/
public,void,TimedWaitReconnection()
{
try
{
IRoomModel,room,;
for,(Object,roomKey,:,roomList.keySet())
{
room,=,(IRoomModel)roomList.get(roomKey),;
if,(room.isWaitReconnection())
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,??????
room.setCurWaitReconnectionTime(
room.getCurWaitReconnectionTime(),+,GameLPU.DELAY
),;
if,(room.getCurWaitReconnectionTime(),>=,room.getMaxWaitReconnectionTime())
{
//
IUserModel,waitUser,=,room.getWaitReconnectionUser().clone(),;
String,waitUserIpPort,=,waitUser.getstrIpPort(),;
room.setWaitReconnection(null),;
//????,,,,,,,,,,,,,,,,,,,,,,,,,,,,
room.setGameOver(waitUser),;
//check,game,over
logicCheckGameOver(room.getId(),,waitUserIpPort),;
//
room.setLeaveUser(waitUser),;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
}
}
catch,(JDOMException,|,IOException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedWaitReconnection",,exd.getMessage(),exd.getStackTrace()),;
}
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,???????????
/**,
?????
*/
public,void,doorVerChk(AppSession,session,,XmlDocument,doc),,
{
try
{
//doc
//<msg,t='sys'><body,action='verChk',r='0'><ver,v='153',/></body></msg>
XmlNode,node,=,doc.SelectSingleNode("/msg/body/ver"),;
//
int,clientVer,=,Integer.parseInt(node.getAttributeValue("v")),;
//??????
String,saction,=,"",;
//????230
if,(clientVer,>=,230)
{
//saction,=,ServerAction.apiOK,;
}
else
{
//saction,=,ServerAction.apiKO,;
}
//??????
saction,=,ServerAction.apiOK,;
//??
Send(session,,XmlInstruction.fengBao(saction)),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
}
catch,(JDOMException,|,UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorVerChk",,exd.getMessage()),;
}
}
/**,
@param,session
@param,doc
@param,item
*/
public,void,doorListModule(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
//var
String,svrAction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
//send
svrAction,=,ServerAction.listModule,;
contentXml.append("<module>"),;
//module,list
//foreach,(object,key,in,roomList.Keys)
//{
contentXml.append("<m,n='"),;
contentXml.append(DdzLogic_Toac.name),;
contentXml.append("',run='"),;
contentXml.append((new,Integer(DdzLogic_Toac.turnOver_a_Card_module_run)).toString()),;
//
contentXml.append("',g1='"),;
contentXml.append(DdzLogic_Toac.getg1()),;
contentXml.append("',g2='"),;
contentXml.append(DdzLogic_Toac.getg2()),;
contentXml.append("',g3='"),;
contentXml.append(DdzLogic_Toac.getg3()),;
contentXml.append("',/>"),;
//}
contentXml.append("</module>"),;
//??
Send(session,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//log
Log.WriteStrBySend(svrAction,,session.getRemoteEndPoint().toString()),;
}
catch,(UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorListModule",,exd.getMessage()),;
}
}
/**,
?????????
@param,session
@param,doc
?????
*/
/**,
?????????
@param,session
@param,doc
?????
*/
public,void,doorListRoom(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
//var
String,svrAction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
int,tab,=,0,;
//read
XmlNode,node,=,doc.SelectSingleNode("/msg/body"),;
tab,=,Integer.parseInt(node.ChildNodes()[0].getText()),;
//??tab???
if,(!logicHasTab(tab))
{
return,;
}
//send
svrAction,=,ServerAction.listHallRoom,;
//
int,tabNum,=,tabList.size(),;
//
contentXml.append("<tabList>"),;
//
for,(int,i,=,0,;,i,<,tabNum,;,i++)
{
ITabModel,t,=,(ITabModel)tabList.get(i),;
contentXml.append(t.toXMLString()),;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
}
//
contentXml.append("</tabList>"),;
//
ITabModel,tabModel,=,logicGetTab(tab),;,,,,,,,,,,,,,,,,,,,
TabModelByDdz,tabDdzModel,=,(TabModelByDdz)tabModel,;
contentXml.append("<t,id='"),;
contentXml.append(tabModel.getTab()),;
contentXml.append("',autoMatchMode='"),;
contentXml.append(tabModel.getTabAutoMatchMode()),;
contentXml.append("',>"),;
//
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
if,(room.getTab(),==,tab)
{
contentXml.append("<r,id='"),;
contentXml.append(room.getId()),;
//???????????,???1
contentXml.append("',n='"),;
contentXml.append(room.getName()),;
contentXml.append("',p='"),;
contentXml.append(room.getSomeBodyChairCount()),;
contentXml.append("',dg='"),;
contentXml.append(room.getDig()),;
contentXml.append("',cg='"),;
contentXml.append(room.getCarryg()),;
contentXml.append("',/>"),;
}
}
contentXml.append("</t>"),;
//??
Send(session,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//log
Log.WriteStrBySend(svrAction,,session.getRemoteEndPoint().toString()),;
}
catch,(JDOMException,|,UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorListRoom",,exd.getMessage()),;
}
}
/**,
????
@param,clientTmp
@param,xml
@param,clients
*/
public,void,doorJoinRoom(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
//1.???????
//2.??
XmlNode,node,=,doc.SelectSingleNode("/msg/body/room"),;
String,roomId,=,node.getAttributeValue("id"),;
//????????
String,pwd,=,node.getAttributeValue("pwd"),;
String,old,=,node.getAttributeValue("old"),;
//
String,saction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
String,roomXml,=,"",;
//??roomId???
if,(!logicHasRoom(Integer.parseInt(roomId)))
{
return,;
}
//?????????
//?????????,
//??????old????????
//????????????
if,(logicHasRoom(Integer.parseInt(old)))
{
if,(logicHasUserInRoom(session.getRemoteEndPoint().toString(),,Integer.parseInt(old)))
{
logicLeaveRoom(session.getRemoteEndPoint().toString()),;
}
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????
//ToSitDownStatus,sitDownStatus,=,ToSitDownStatus.forValue(0),;
int,sitDownStatus,;
//tangible.RefObject<ToSitDownStatus>,tempRef_sitDownStatus,=,new,tangible.RefObject<ToSitDownStatus>(sitDownStatus),;
//boolean,sitDown,=,logicHasIdleChairAndSitDown(Integer.parseInt(roomId),,session.getRemoteEndPoint().toString(),,tempRef_sitDownStatus),;
String[],sitDownResult,=,logicHasIdleChairAndSitDown(Integer.parseInt(roomId),,session.getRemoteEndPoint().toString()),;
boolean,sitDown,=,Boolean.parseBoolean(sitDownResult[0]),;
sitDownStatus,=,parseInt(sitDownResult[1]),;
if,(sitDown)
{
saction,=,ServerAction.joinOK,;
//?????xml??
IRoomModel,room,=,logicGetRoom(Integer.parseInt(roomId)),;
roomXml,=,room.toXMLString(),;
//???????status
//contentXml.Append("<status>0</status>"),;
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
//??,uER,=,UserEnterRoom
String,saction_uER,=,ServerAction.uER,;
IUserModel,sitDownUser,=,logicGetUser(session.getRemoteEndPoint().toString()),;
String,chairAndUserXml,=,room.getChair(sitDownUser).toXMLString(),;
netTurnRoom(session.getRemoteEndPoint().toString(),,Integer.parseInt(roomId),,saction_uER,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,roomId,,"",,saction_uER),;
}
else
{
saction,=,ServerAction.joinKO,;
//?????xml??
roomXml,=,logicGetRoom(Integer.parseInt(roomId)).toXMLString(),;
if,(sitDownStatus,==,ToSitDownStatus.NoIdleChair1)
{
//code,?,status,?????,??as3,help???????code
contentXml.append("<code>1</code>"),;
}
else,if,(sitDownStatus,==,ToSitDownStatus.ErrorRoomPassword2)
{
contentXml.append("<code>2</code>"),;
}
else
{
contentXml.append("<code>3</code>"),;
}
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
},//end,if
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
catch,(IOException,|,JDOMException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorJoinRoom",,exd.getMessage(),exd.getStackTrace()),;
}
}
/**,
@param,session
@param,doc
@param,item
*/
public,void,doorJoinReconnectionRoom(AppSession,session,,XmlDocument,doc,,SessionMessage,item),throws,UnsupportedEncodingException
{
try
{
//1.????????
//2.??
XmlNode,node,=,doc.SelectSingleNode("/msg/body/room"),;
String,roomId,=,node.getAttributeValue("id"),;
//????????
String,pwd,=,node.getAttributeValue("pwd"),;
String,old,=,node.getAttributeValue("old"),;
//
if,(!logicHasUser(session.getRemoteEndPoint().toString()))
{
return,;
}
IUserModel,user,=,logicGetUser(session.getRemoteEndPoint().toString()),;
//
String,saction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
StringBuilder,filterContentXml,=,new,StringBuilder(),;
String,roomXml,=,"",;
String,filterRoomXml,=,"",;
//???roomId??,
roomId,=,"-1",;
//search
IRoomModel,room,=,null,;
for,(Object,key,:,roomList.keySet())
{
//
room,=,(IRoomModel)roomList.get(key),;
if,(room.isWaitReconnection())
{
if,(room.getWaitReconnectionUser().getId().equals(user.getId()))
{
roomId,=,String.valueOf(room.getId()),;
break,;
}
}
}
//??????????
//????????
if,(!roomId.equals("-1"),&&,null,!=,room)
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????
//ToSitDownStatus
int,,sitDownStatus,=,ToSitDownStatus.Success0,;
//tangible.RefObject<ToSitDownStatus>,tempRef_sitDownStatus,=,new,tangible.RefObject<ToSitDownStatus>(sitDownStatus),;
//boolean,sitDown,=,logicHasIdleChairAndSitDown(Integer.parseInt(roomId),,session.getRemoteEndPoint().toString(),,tempRef_sitDownStatus),;
String[],sitDownResult,=,logicHasIdleChairAndSitDown(Integer.parseInt(roomId),,session.getRemoteEndPoint().toString()),;//,,tempRef_sitDownStatus),;
boolean,sitDown,=,Boolean.parseBoolean(sitDownResult[0]),;
sitDownStatus,=,parseInt(sitDownResult[1]),;
if,(sitDown)
{
//
room.setWaitReconnection(null),;
//
saction,=,ServerAction.joinOK,;
//?????xml??
//IRoomModel,room,=,logicGetRoom(int.Parse(roomId)),;
roomXml,=,room.toXMLString(),;
roomXml,=,room.getFilterContentXml(session.getRemoteEndPoint().toString(),,roomXml),;
//???????status
//contentXml.Append("<status>0</status>"),;
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
//??
Send(session,,XmlInstruction.fengBao(ServerAction.joinReconnectionOK,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
//??,uER,=,UserEnterRoom
String,saction_uER,=,ServerAction.uER,;
IUserModel,sitDownUser,=,logicGetUser(session.getRemoteEndPoint().toString()),;
String,chairAndUserXml,=,room.getChair(sitDownUser).toXMLString(),;
netTurnRoom(session.getRemoteEndPoint().toString(),,Integer.parseInt(roomId),,saction_uER,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,roomId,,"",,saction_uER),;
//??,waitReconnectionEnd
netTurnRoom(session.getRemoteEndPoint().toString(),,Integer.parseInt(roomId),,ServerAction.userWaitReconnectionRoomEnd,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,roomId,,"",,ServerAction.userWaitReconnectionRoomEnd),;
}
else
{
saction,=,ServerAction.joinKO,;
//?????xml??
roomXml,=,logicGetRoom(Integer.parseInt(roomId)).toXMLString(),;
if,(sitDownStatus,==,ToSitDownStatus.NoIdleChair1)
{
//code,?,status,?????,??as3,help???????code
contentXml.append("<code>1</code>"),;
}
else,if,(sitDownStatus,==,ToSitDownStatus.ErrorRoomPassword2)
{
contentXml.append("<code>2</code>"),;
}
else
{
contentXml.append("<code>3</code>"),;
}
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(saction,,contentXml.toString())),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
},//end,if
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
else
{
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,?????????
saction,=,ServerAction.joinReconnectionKO,;
//??
Send(session,,XmlInstruction.fengBao(saction,,"")),;
//
Log.WriteStrBySend(saction,,session.getRemoteEndPoint().toString()),;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
}
}
catch,(JDOMException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorJoinRoom",,exd.getMessage()),;
}
}
/**,
??????
?????tab??,???????
@param,session
@param,doc
*/
public,void,doorAutoJoinRoom(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
//var,
String,svrAction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
String,roomXml,=,"",;
int,tab,=,0,;
//
XmlNode,node,=,doc.SelectSingleNode("/msg/body/room"),;
String,old,=,node.getAttributeValue("old"),;
XmlNode,node2,=,doc.SelectSingleNode("/msg/body/tab"),;
tab,=,Integer.parseInt(node2.getText()),;
//?????????
//?????????,
//??????old????????
//????????????
if,(logicHasRoom(Integer.parseInt(old)))
{
if,(logicHasUserInRoom(session.getRemoteEndPoint().toString(),,Integer.parseInt(old)))
{
logicLeaveRoom(session.getRemoteEndPoint().toString()),;
}
}
//????
//ToSitDownStatus
String[],sitDownResult,;
int,sitDownStatus,=,ToSitDownStatus.ProviderError3,;
boolean,sitDown,=,false,;
int,roomId,=,-1,;
int,matchLvl,=,1,;
//?????1?
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
if,(room.getTab(),==,tab)
{
roomId,=,room.getId(),;
//???????,?1??????
//????????????,??????????
//tangible.RefObject<ToSitDownStatus>,tempRef_sitDownStatus,=,new,tangible.RefObject<ToSitDownStatus>(sitDownStatus),;
//sitDown,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,session.getRemoteEndPoint().toString(),,false,,tempRef_sitDownStatus),;
sitDownResult,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,session.getRemoteEndPoint().toString(),,false),;
sitDown,=,Boolean.parseBoolean(sitDownResult[0]),;
sitDownStatus,=,parseInt(sitDownResult[1]),;//tempRef_sitDownStatus.argvalue,;
if,(sitDown)
{
break,;
},//end,if
},//end,if
},//end,for
//?????2?
if,(!sitDown)
{
matchLvl++,;
for,(Object,key2,:,roomList.keySet())
{
IRoomModel,room2,=,(IRoomModel)roomList.get(key2),;
if,(room2.getTab(),==,tab)
{
roomId,=,room2.getId(),;
//???????,?1??????
//????????????,??????????
//tangible.RefObject<ToSitDownStatus>,tempRef_sitDownStatus2,=,new,tangible.RefObject<ToSitDownStatus>(sitDownStatus),;
sitDownResult,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,session.getRemoteEndPoint().toString(),,false),;//,,tempRef_sitDownStatus2),;
sitDown,=,Boolean.parseBoolean(sitDownResult[0]),;
sitDownStatus,=,parseInt(sitDownResult[1]),;//tempRef_sitDownStatus2.argvalue,;
if,(sitDown)
{
break,;
},//end,if
},//end,if
},//end,for
},//end,if
//?????3?
if,(!sitDown)
{
matchLvl++,;
for,(Object,key3,:,roomList.keySet())
{
IRoomModel,room3,=,(IRoomModel)roomList.get(key3),;
if,(room3.getTab(),==,tab)
{
roomId,=,room3.getId(),;
//???????,?1??????
//????????????,??????????
//tangible.RefObject<ToSitDownStatus>,tempRef_sitDownStatus3,=,new,tangible.RefObject<ToSitDownStatus>(sitDownStatus),;
sitDownResult,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,session.getRemoteEndPoint().toString(),,false),;//,,tempRef_sitDownStatus3),;
sitDown,=,Boolean.parseBoolean(sitDownResult[0]),;
sitDownStatus,=,parseInt(sitDownResult[1]),;//tempRef_sitDownStatus3.argvalue,;
if,(sitDown)
{
break,;
},//end,if
},//end,if
},//end,for
},//end,if
if,(sitDown)
{
svrAction,=,ServerAction.joinOK,;
//?????xml??
IRoomModel,room,=,logicGetRoom(roomId),;
roomXml,=,room.toXMLString(),;
//???????code
//contentXml.Append("<code>0</code>"),;
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//log
Log.WriteStrBySend(svrAction,,session.getRemoteEndPoint().toString()),;
//??,uER,=,UserEnterRoom
String,svrAction_uER,=,ServerAction.uER,;
IUserModel,sitDownUser,=,logicGetUser(session.getRemoteEndPoint().toString()),;
String,chairAndUserXml,=,room.getChair(sitDownUser).toXMLString(),;
netTurnRoom(session.getRemoteEndPoint().toString(),,roomId,,svrAction_uER,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,String.valueOf(roomId),,"",,svrAction_uER),;
}
else
{
//
svrAction,=,ServerAction.joinKO,;
//?????xml??
roomXml,=,logicGetRoom(roomId).toXMLString(),;
if,(sitDownStatus,==,ToSitDownStatus.NoIdleChair1)
{
//code,?,status,?????,??as3,help???????code
contentXml.append("<code>1</code>"),;
}
else,if,(sitDownStatus,==,ToSitDownStatus.ErrorRoomPassword2)
{
contentXml.append("<code>2</code>"),;
}
else
{
contentXml.append("<code>3</code>"),;
}
contentXml.append(roomXml),;
//??
Send(session,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//
Log.WriteStrBySend(svrAction,,session.getRemoteEndPoint().toString()),;
},//end,if
}
catch,(IOException,|,JDOMException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorAutoJoinRoom",,exd.getMessage(),exd.getStackTrace()),;
}
}
public,void,doorAutoMatchRoom(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
int,tab,=,0,;
//
XmlNode,node,=,doc.SelectSingleNode("/msg/body/room"),;
String,old,=,node.getAttributeValue("old"),;
XmlNode,node2,=,doc.SelectSingleNode("/msg/body/tab"),;
tab,=,parseInt(node2.getText()),;//InnerText),;
//
String,strIpPort,=,session.getRemoteEndPoint().toString(),;
//
int,roomOldId,=,Integer.parseInt(old),;
AutoMatchRoomModel,amr,=,new,AutoMatchRoomModel(strIpPort,,tab,,roomOldId),;
//
if,(!getAutoMatchWaitList().containsKey(strIpPort))
{
getAutoMatchWaitList().put(strIpPort,,amr),;
}
else
{
getAutoMatchWaitList().put(strIpPort,,amr),;
}
}
catch,(JDOMException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"doorAutoMatchRoom",,exd.getMessage(),exd.getStackTrace()),;
}
}
public,void,TimedAutoMatchRoom()
{
try
{
int,count,=,getAutoMatchWaitList().keySet().size(),;
Object[],keysList,;//,=,new,Object[count],;
//getAutoMatchWaitList().keySet().CopyTo(keysList,,0),;
keysList,=,getAutoMatchWaitList().keySet().toArray(),;,,,,,,,,,,,,,,,,,,,,
//
int,keysLen,=,keysList.length,;
int,i,=,0,;
//
IRoomModel,room,=,null,;
IRoomModel,roomChk,=,null,;
//foreach,(object,amrKey,in,AutoMatchWaitList().Keys)
for,(i,=,0,;,i,<,keysLen,;,i++)
{
AutoMatchRoomModel,amr,=,(AutoMatchRoomModel)getAutoMatchWaitList().get(keysList[i]),;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????
//??????
if,(!netHasSession(amr.getStrIpPort()),||,!logicHasUser(amr.getStrIpPort()))
{
getAutoMatchWaitList().remove(amr.getStrIpPort()),;
continue,;
}
IUserModel,user,=,logicGetUser(amr.getStrIpPort()),;
AppSession,userSession,=,netGetSession(amr.getStrIpPort()),;
//?????????
for,(Object,roomKey,:,roomList.keySet())
{
roomChk,=,(IRoomModel)roomList.get(roomKey),;
if,(logicQueryUserInRoom(user.getStrIpPort(),,roomChk.getId()))
{
//?????????????
getAutoMatchWaitList().remove(amr.getStrIpPort()),;
continue,;
}
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//????
//????
int,sitDownStatus,=,ToSitDownStatus.ProviderError3,;
boolean,sitDown,=,false,;
int,roomId,=,-1,;
int,matchLvl,=,1,;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????1???
Object[],argvalue,=,TimedAutoMatchRoom_Sub_Match(room,,amr,,user,,userSession,,sitDownStatus,,sitDown,,roomId,,matchLvl),;
room,=,(IRoomModel)argvalue[0],;
sitDownStatus,=,(int)argvalue[1],;
sitDown,=,(Boolean)argvalue[2],;
roomId,=,(int)argvalue[3],;
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????2???
if,(!sitDown)
{
matchLvl++,;
argvalue,=,TimedAutoMatchRoom_Sub_Match(room,,amr,,user,,userSession,,sitDownStatus,,sitDown,,roomId,,matchLvl),;
room,=,(IRoomModel)argvalue[0],;
sitDownStatus,=,(int)argvalue[1],;
sitDown,=,(Boolean)argvalue[2],;
roomId,=,(int)argvalue[3],;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????1???
if,(!sitDown)
{
matchLvl++,;
argvalue,=,,TimedAutoMatchRoom_Sub_Match(room,,amr,,user,,userSession,,sitDownStatus,,sitDown,,roomId,,matchLvl),;
room,=,(IRoomModel)argvalue[0],;
sitDownStatus,=,(int)argvalue[1],;
sitDown,=,(Boolean)argvalue[2],;
roomId,=,(int)argvalue[3],;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#region,????0???
if,(!sitDown)
{
matchLvl++,;
argvalue,=,,TimedAutoMatchRoom_Sub_Match(room,,amr,,user,,userSession,,sitDownStatus,,sitDown,,roomId,,matchLvl),;
room,=,(IRoomModel)argvalue[0],;
sitDownStatus,=,(int)argvalue[1],;
sitDown,=,(Boolean)argvalue[2],;
roomId,=,(int)argvalue[3],;
}
//C#,TO,JAVA,CONVERTER,TODO,TASK:,There,is,no,preprocessor,in,Java:
///#endregion
if,(sitDown)
{
getAutoMatchWaitList().remove(amr.getStrIpPort()),;
continue,;
}
},//end,for
}
catch,(Exception,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedAutoMatchRoom",,exd.getMessage()),;
}
}
private,Object[],TimedAutoMatchRoom_Sub_Match(IRoomModel,room,,
AutoMatchRoomModel,amr,,
IUserModel,user,,
AppSession,userSession,,
int,sitDownStatus,,
boolean,sitDown,,
int,roomId,,
int,matchLvl)
{
Object[],argvalue,=,new,Object[4],;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
try
{
for,(Object,roomKey,:,roomList.keySet())
{
room,=,(IRoomModel)roomList.get(roomKey),;
//?????1?
if,(amr.getTab(),==,room.getTab())
{
roomId,=,room.getId(),;
//????????,?????????????,???????
if,(amr.getRoomOldId(),==,roomId)
{
continue,;
}
//???????????
if,(room.hasGamePlaying())
{
continue,;
}
//???????????
if,(room.isWaitReconnection())
{
continue,;
}
//?????????
if,(logicChkRoomByDeadPeople(roomId))
{
continue,;
}
//???????,?1??????
//????????????,??????????
String[],sitDownResult,=,logicHasIdleChairAndMatchSitDown(roomId,,matchLvl,,userSession.getRemoteEndPoint().toString(),,true),;//,,sitDownStatus),;
sitDown,=,Boolean.valueOf(sitDownResult[0]),;
if,(sitDown)
{
TimedAutoMatchRoom_Sub_SitDown_Ok(room,,userSession),;
break,;
},//end,if
},//end,if
},//end,for
argvalue[0],=,room,;
argvalue[1],=,sitDownStatus,;
argvalue[2],=,sitDown,;
argvalue[3],=,roomId,;
}
catch,(RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedAutoMatchRoom_Sub_Match",,exd.getMessage()),;
}
return,argvalue,;
}
/**,
TimedAutoMatch????,????
@param,room
@param,userSession
*/
private,void,TimedAutoMatchRoom_Sub_SitDown_Ok(IRoomModel,room,,AppSession,userSession)
{
try
{
String,svrAction,=,ServerAction.joinOK,;
//
StringBuilder,contentXml,=,new,StringBuilder(),;
//?????xml??
//IRoomModel,room,=,logicGetRoom(roomId),;
String,roomXml,=,room.toXMLString(),;
//???????code
//contentXml.Append("<code>0</code>"),;
contentXml.append(roomXml),;
//??
Send(userSession,,XmlInstruction.fengBao(svrAction,,contentXml.toString())),;
//log
Log.WriteStrBySend(svrAction,,userSession.getRemoteEndPoint().toString()),;
//??,uER,=,UserEnterRoom
String,svrAction_uER,=,ServerAction.uER,;
IUserModel,sitDownUser,=,logicGetUser(userSession.getRemoteEndPoint().toString()),;
String,chairAndUserXml,=,room.getChair(sitDownUser).toXMLString(),;
netTurnRoom(userSession.getRemoteEndPoint().toString(),,room.getId(),,svrAction_uER,,chairAndUserXml),;
Log.WriteStrByTurn(SR.getRoom_displayName(),+,String.valueOf(room.getId()),,"",,svrAction_uER),;
}
catch,(UnsupportedEncodingException,|,RuntimeException,exd)
{
Log.WriteStrByException(CLASS_NAME,,"TimedAutoMatch_Sub_SitDown",,exd.getMessage()),;
}
}
/**,
?????????
@param,session
@param,doc
?????
*/
public,void,doorLoadD(AppSession,session,,XmlDocument,doc,,SessionMessage,item)
{
try
{
//var,
String,svrAction,=,"",;
StringBuilder,contentXml,=,new,StringBuilder(),;
//send
svrAction,=,ServerAction.dList,;
//
java.util.ArrayList<String>,userStrIpPortList,=,CLIENTAcceptor.getUserList(),;
//
java.util.ArrayList<String>,idleList,=,new,java.util.ArrayList<String>(),;
//
int,i,=,0,;
int,len,=,userStrIpPortList.size(),;
//???????
for,(i,=,0,;,i,<,len,;,i++)
{
//if,(logicHasUser(userStrIpPortList[i]))
//{
boolean,userInRoom,=,false,;
//--
for,(Object,key,:,roomList.keySet())
{
IRoomModel,room,=,(IRoomModel)roomList.get(key),;
//logicHasUserInRoom
if,(logicQueryUserInRoom(userStrIpPortList.get(i),,room.getId()))
{
userInRoom,=,true,;
break,;
}
},//end,for
if,(!userInRoom)
{
//idleList.Add(logicGetUser(userStrIpPortList[i])),;
idleList.add(userStrIpPortList.get(i)),;
}
//--
//}//end,if,,
},//end,for
